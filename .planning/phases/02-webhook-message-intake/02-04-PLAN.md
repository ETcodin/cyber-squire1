---
phase: 02-webhook-message-intake
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - .planning/phases/02-webhook-message-intake/02-04-TEST-RESULTS.md
autonomous: false

must_haves:
  truths:
    - "10 consecutive messages processed without loss"
    - "3-message burst (within 2 seconds) all processed in order"
    - "Webhook survives simulated n8n restart"
    - "Duplicate message_id is not processed twice"
  artifacts:
    - path: ".planning/phases/02-webhook-message-intake/02-04-TEST-RESULTS.md"
      provides: "Integration test documentation"
      contains: "PASS"
  key_links:
    - from: "Telegram Bot"
      to: "n8n execution history"
      via: "webhook trigger"
      pattern: "execution"
---

<objective>
Execute integration tests to verify all Phase 2 success criteria are met.

Purpose: Validate SC-2.1 through SC-2.4 with real message delivery and processing.

Output: Documented test results proving webhook intake works correctly.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-webhook-message-intake/02-01-SUMMARY.md
@.planning/phases/02-webhook-message-intake/02-02-SUMMARY.md
@.planning/phases/02-webhook-message-intake/02-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete webhook and message intake system:
    - Telegram webhook trigger in Supervisor Agent workflow
    - Startup webhook registration workflow
    - Message deduplication via PostgreSQL
    - Comprehensive logging
  </what-built>
  <how-to-verify>
    **Pre-requisites (user must complete):**
    1. Import all updated workflows into n8n:
       - workflow_supervisor_agent.json
       - workflow_startup_webhook.json (if created)
    2. Activate workflows in n8n UI
    3. Configure Telegram credential (telegram-bot-main) if not already done
    4. Execute create_message_log.sql on PostgreSQL

    **Test 1: Basic Message Delivery (SC-2.1)**
    1. Open Telegram and message @Coredirective_bot
    2. Send: "Hello, this is test message 1"
    3. Check n8n execution history
    4. Verify: Execution shows payload with chat_id, text, timestamp
    - [ ] PASS / FAIL

    **Test 2: Message Burst Handling (SC-2.2)**
    1. Rapidly send 3 messages within 2 seconds:
       - "Burst 1"
       - "Burst 2"
       - "Burst 3"
    2. Check n8n execution history
    3. Verify: All 3 messages have separate executions
    4. Verify: Messages processed in order (check timestamps)
    - [ ] PASS / FAIL

    **Test 3: Webhook Persistence (SC-2.3)**
    Option A (if startup workflow deployed):
    1. Trigger n8n restart: `docker restart cd-service-n8n`
    2. Wait 60 seconds for startup
    3. Send test message to bot
    4. Verify: Message received and processed

    Option B (manual):
    1. Check webhook status: Call getWebhookInfo API
    2. Verify URL matches expected

    - [ ] PASS / FAIL

    **Test 4: Duplicate Prevention (SC-2.4)**
    1. Note the message_id of a recent test message from n8n logs
    2. Manually replay the webhook payload using curl:
       ```bash
       curl -X POST https://cyber-squire.tigouetheory.com/webhook/supervisor-agent-v1 \
         -H "Content-Type: application/json" \
         -d '{"message":{"message_id":SAME_ID,"chat":{"id":YOUR_CHAT_ID},"text":"Duplicate test"}}'
       ```
    3. Check n8n execution history
    4. Verify: Second execution shows "Skip Duplicate" path taken
    - [ ] PASS / FAIL

    **Test 5: Consecutive Message Processing**
    1. Send 10 messages sequentially (one every 2 seconds)
    2. Check n8n execution history
    3. Verify: All 10 executions complete successfully
    - [ ] PASS / FAIL

    **Exit Gate Verification:**
    - [ ] 10 consecutive test messages processed without loss
    - [ ] Message queue handles burst without duplicates
  </how-to-verify>
  <resume-signal>
    Report results in this format:
    "Test 1: PASS, Test 2: PASS, Test 3: PASS, Test 4: PASS, Test 5: PASS"
    Or describe any failures.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Document test results</name>
  <files>.planning/phases/02-webhook-message-intake/02-04-TEST-RESULTS.md</files>
  <action>
    Based on user's verification feedback, create test results documentation:

    ```markdown
    # Phase 02 Integration Test Results

    **Date:** [current date]
    **Tester:** [user]

    ## Test Results Summary

    | Test | Criteria | Result | Notes |
    |------|----------|--------|-------|
    | Basic Message Delivery | SC-2.1 | [PASS/FAIL] | [notes] |
    | Message Burst Handling | SC-2.2 | [PASS/FAIL] | [notes] |
    | Webhook Persistence | SC-2.3 | [PASS/FAIL] | [notes] |
    | Duplicate Prevention | SC-2.4 | [PASS/FAIL] | [notes] |
    | Consecutive Messages | Exit Gate | [PASS/FAIL] | [notes] |

    ## Exit Gate Status

    - [ ] 10 consecutive test messages processed without loss
    - [ ] Message queue handles burst without duplicates

    ## Phase 2 Status: [COMPLETE/INCOMPLETE]

    ## Issues Found
    [Document any failures and their symptoms]

    ## Recommendations
    [Any follow-up actions needed]
    ```

    If any tests failed, document the failure and create gap closure notes.
  </action>
  <verify>
    test -f .planning/phases/02-webhook-message-intake/02-04-TEST-RESULTS.md && echo "Results documented"
  </verify>
  <done>
    Test results documented with clear PASS/FAIL for each success criterion.
  </done>
</task>

</tasks>

<verification>
1. All 5 integration tests executed
2. Results documented in TEST-RESULTS.md
3. Exit gate criteria evaluated
4. Phase 2 status determined
</verification>

<success_criteria>
- SC-2.1: VERIFIED via Test 1
- SC-2.2: VERIFIED via Test 2
- SC-2.3: VERIFIED via Test 3
- SC-2.4: VERIFIED via Test 4
- Exit Gate: VERIFIED via Test 5
</success_criteria>

<output>
After completion, create `.planning/phases/02-webhook-message-intake/02-04-SUMMARY.md`
</output>
