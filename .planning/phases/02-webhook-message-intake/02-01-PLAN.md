---
phase: 02-webhook-message-intake
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
  - COREDIRECTIVE_ENGINE/workflow_startup_webhook.json
autonomous: true

must_haves:
  truths:
    - "Telegram message triggers n8n webhook execution"
    - "Webhook URL is registered with Telegram on n8n startup"
    - "Cloudflare Tunnel routes webhook traffic to n8n"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json"
      provides: "Main Telegram webhook trigger workflow"
      contains: "telegramTrigger"
    - path: "COREDIRECTIVE_ENGINE/workflow_startup_webhook.json"
      provides: "Startup webhook registration"
      contains: "setWebhook"
  key_links:
    - from: "Telegram Bot"
      to: "n8n webhook endpoint"
      via: "Cloudflare Tunnel"
      pattern: "webhook.*supervisor"
    - from: "workflow_startup_webhook.json"
      to: "Telegram API"
      via: "setWebhook call"
      pattern: "setWebhook"
---

<objective>
Configure the Supervisor Agent workflow to receive all Telegram messages via webhook, and create a startup workflow that registers the webhook when n8n boots.

Purpose: Establish the primary message intake channel (ROUTE-01) and ensure webhook persistence after restarts (SC-2.3).

Output: Working webhook endpoint that receives Telegram messages and auto-registers on n8n startup.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
@COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate and update Supervisor Agent webhook configuration</name>
  <files>COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json</files>
  <action>
    Verify the existing `workflow_supervisor_agent.json` has correct webhook configuration:

    1. Check webhook trigger node:
       - Type: `n8n-nodes-base.telegramTrigger`
       - Updates: `["message", "callback_query"]`
       - webhookId: Should be unique identifier (keep existing `supervisor-agent-v1`)
       - Credential reference: `telegram-bot-main` (standardize from `telegram-bot-op-nuclear`)

    2. Update credential reference to match Phase 1 standard (`telegram-bot-main`):
       - Find all nodes using `telegram-bot-op-nuclear`
       - Replace with `telegram-bot-main` for consistency

    3. Ensure the webhook path is deterministic and documented:
       - Expected: `/webhook/supervisor-agent-v1` or similar
       - Document the full URL pattern: `https://cyber-squire.tigouetheory.com/webhook/{webhookId}`

    Do NOT modify the AI agent logic, memory configuration, or tool connections.
  </action>
  <verify>
    grep -E "telegram-bot-main" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json | wc -l
    # Should return count > 0 (all Telegram nodes use consistent credential)

    grep -E "telegramTrigger" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
    # Should show trigger node exists
  </verify>
  <done>
    Supervisor Agent workflow uses `telegram-bot-main` credential consistently and has valid webhook trigger configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create startup webhook registration workflow</name>
  <files>COREDIRECTIVE_ENGINE/workflow_startup_webhook.json</files>
  <action>
    Create a new workflow that registers the Telegram webhook when n8n starts:

    1. Trigger: `n8n-nodes-base.n8nTrigger` with event `Instance started`
       - This fires when n8n boots/restarts

    2. Set Webhook node:
       - HTTP Request to `https://api.telegram.org/bot{token}/setWebhook`
       - Parameters:
         - url: `{{ $env.TELEGRAM_WEBHOOK_URL }}` (e.g., `https://cyber-squire.tigouetheory.com/webhook/supervisor-agent-v1`)
         - max_connections: 40
         - allowed_updates: `["message","callback_query"]`
       - Use Telegram credential (`telegram-bot-main`)

    3. Verify Webhook node:
       - HTTP Request to `getWebhookInfo` to confirm registration

    4. Log Success node:
       - Code node that outputs registration status

    Pattern from existing `workflow_webhook_healthcheck.json` for setWebhook/getWebhookInfo calls.

    Name: "Telegram Webhook Startup Registration"
    Tags: ["CoreDirective", "Telegram", "Startup"]
  </action>
  <verify>
    # File exists
    test -f COREDIRECTIVE_ENGINE/workflow_startup_webhook.json && echo "EXISTS"

    # Has startup trigger
    grep -E "n8nTrigger|Instance started" COREDIRECTIVE_ENGINE/workflow_startup_webhook.json

    # Has setWebhook call
    grep "setWebhook" COREDIRECTIVE_ENGINE/workflow_startup_webhook.json
  </verify>
  <done>
    Startup workflow exists, triggers on n8n boot, and registers Telegram webhook automatically.
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy workflows to EC2 and verify webhook registration</name>
  <files></files>
  <action>
    Deploy the updated workflows to the EC2 instance and verify webhook is registered:

    1. SCP updated files to EC2:
       ```bash
       scp -i ~/.ssh/cyber-squire-key.pem COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json \
           ec2-user@54.234.155.244:/tmp/
       scp -i ~/.ssh/cyber-squire-key.pem COREDIRECTIVE_ENGINE/workflow_startup_webhook.json \
           ec2-user@54.234.155.244:/tmp/
       ```

    2. Document n8n import instructions (workflows must be imported via n8n UI):
       - Access: https://cyber-squire.tigouetheory.com
       - Import: Workflows > Import from File
       - Activate: Toggle workflow active

    3. Verify webhook registration via API:
       ```bash
       ssh -i ~/.ssh/cyber-squire-key.pem ec2-user@54.234.155.244 \
         'docker exec cd-service-n8n wget -qO- "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getWebhookInfo"'
       ```
       Expected: JSON with `url` field matching expected webhook URL

    4. Test message delivery:
       - Send test message to bot
       - Check n8n execution history for new execution

    Note: If SSH key is not available locally, provide instructions for manual deployment.
  </action>
  <verify>
    # Check if workflows were transferred
    ssh -i ~/.ssh/cyber-squire-key.pem ec2-user@54.234.155.244 'ls -la /tmp/workflow_*.json 2>/dev/null'

    # If SSH not available, verify files exist locally
    ls -la COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json COREDIRECTIVE_ENGINE/workflow_startup_webhook.json
  </verify>
  <done>
    Workflows transferred to EC2, ready for n8n import. Webhook URL documented for manual verification.
  </done>
</task>

</tasks>

<verification>
1. `workflow_supervisor_agent.json` uses consistent `telegram-bot-main` credential
2. `workflow_startup_webhook.json` exists with Instance Started trigger
3. Workflow files transferred to EC2 `/tmp/` directory
4. Documentation created for manual n8n import steps
</verification>

<success_criteria>
- SC-2.1 PARTIAL: Webhook trigger node configured correctly (full test requires n8n UI activation)
- SC-2.3 READY: Startup webhook registration workflow created
</success_criteria>

<output>
After completion, create `.planning/phases/02-webhook-message-intake/02-01-SUMMARY.md`
</output>
