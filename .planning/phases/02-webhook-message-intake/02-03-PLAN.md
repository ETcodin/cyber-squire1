---
phase: 02-webhook-message-intake
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
autonomous: true

must_haves:
  truths:
    - "Every incoming message is logged with timestamp and chat_id"
    - "Execution history shows message payload in n8n logs"
    - "Error states are captured and reported"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json"
      provides: "Message logging nodes"
      contains: "Log"
  key_links:
    - from: "Parse Input"
      to: "Logging node"
      via: "JSON payload extraction"
      pattern: "timestamp"
---

<objective>
Add comprehensive logging to the Supervisor Agent workflow for debugging, audit trail, and operational visibility.

Purpose: Support SC-2.1 verification (payload visible in execution log) and operational debugging.

Output: Logging nodes that capture message metadata without exposing sensitive content.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
@.planning/phases/02-webhook-message-intake/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add message ingestion logging</name>
  <files>COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json</files>
  <action>
    Add a logging node immediately after "Parse Input" to capture incoming messages:

    1. Create "Log Incoming Message" node:
       - Type: `n8n-nodes-base.code`
       - Position: Between "Parse Input" and deduplication check (or AI Agent if no deduplication yet)
       - Code:
         ```javascript
         // Log incoming message metadata (no sensitive content)
         const input = $input.first().json;

         const logEntry = {
           event: 'message_received',
           timestamp: new Date().toISOString(),
           chatId: input.chatId,
           user: input.user,
           firstName: input.firstName,
           messageLength: (input.text || '').length,
           hasText: !!input.text,
           executionId: $execution.id
         };

         console.log(JSON.stringify(logEntry));

         // Pass through unchanged
         return $input.all();
         ```

    2. Update workflow connections:
       - Parse Input -> Log Incoming Message -> (next node)

    3. Note: Logs appear in n8n execution history under "Output" tab
  </action>
  <verify>
    grep "Log Incoming" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
    grep "message_received" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
  </verify>
  <done>
    Every incoming message triggers a log entry with timestamp, chat_id, and message metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add response logging</name>
  <files>COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json</files>
  <action>
    Add logging before the "Send Response" node to capture outgoing responses:

    1. Create "Log Outgoing Response" node:
       - Type: `n8n-nodes-base.code`
       - Position: Between "Format Output" and "Send Response"
       - Code:
         ```javascript
         // Log outgoing response metadata
         const output = $input.first().json;

         const logEntry = {
           event: 'response_sent',
           timestamp: new Date().toISOString(),
           chatId: output.chatId,
           responseLength: (output.text || '').length,
           executionId: $execution.id,
           latencyMs: Date.now() - new Date($('Log Incoming Message').first()?.json?.timestamp || Date.now()).getTime()
         };

         console.log(JSON.stringify(logEntry));

         // Pass through unchanged
         return $input.all();
         ```

    2. Update workflow connections:
       - Format Output -> Log Outgoing Response -> Send Response

    3. This captures:
       - Response timing (latency from intake to response)
       - Response size (for debugging Telegram limits)
  </action>
  <verify>
    grep "Log Outgoing" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
    grep "response_sent" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
    grep "latencyMs" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
  </verify>
  <done>
    Every outgoing response logged with latency metrics and response metadata.
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure error workflow reference</name>
  <files>COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json</files>
  <action>
    Ensure the Supervisor Agent workflow routes errors to the error handler from Phase 1:

    1. Update workflow settings section:
       ```json
       "settings": {
         "executionOrder": "v1",
         "saveManualExecutions": true,
         "errorWorkflow": "workflow_error_handler"
       }
       ```
       Note: The exact errorWorkflow value depends on the workflow ID in n8n. Use the name pattern; n8n will resolve it.

    2. Alternatively, document that error workflow must be configured in n8n UI:
       - Open workflow settings
       - Set "Error Workflow" to "System: Error Handler"

    3. Verify error handler workflow file exists (from Phase 1):
       - `COREDIRECTIVE_ENGINE/workflow_error_handler.json`
  </action>
  <verify>
    grep "errorWorkflow" COREDIRECTIVE_ENGINE/workflow_supervisor_agent.json
    test -f COREDIRECTIVE_ENGINE/workflow_error_handler.json && echo "Error handler exists"
  </verify>
  <done>
    Error workflow reference configured; errors will trigger Telegram alert from Phase 1.
  </done>
</task>

</tasks>

<verification>
1. "Log Incoming Message" node exists in workflow
2. "Log Outgoing Response" node exists with latency calculation
3. Error workflow setting present in workflow JSON
4. JSON remains valid (parseable)
</verification>

<success_criteria>
- SC-2.1 COMPLETE: Webhook payload visible in n8n execution log via logging nodes
- Phase 1 Integration: Errors route to error handler for Telegram alerts
</success_criteria>

<output>
After completion, create `.planning/phases/02-webhook-message-intake/02-03-SUMMARY.md`
</output>
