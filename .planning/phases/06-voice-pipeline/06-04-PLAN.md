---
phase: 06-voice-pipeline
plan: 04
type: execute
wave: 4
depends_on: [06-03]
files_modified:
  - COREDIRECTIVE_ENGINE/workflows/voice_handler.json

must_haves:
  truths:
    - "Transcription failures handled gracefully"
    - "User sees helpful error messages, not crashes"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/voice_handler.json"
      provides: "Error handling for voice pipeline"
      contains: "Try-catch blocks and fallback messages"
---

<objective>
Add error handling and edge cases to voice pipeline.

Purpose: Ensure voice pipeline degrades gracefully when transcription fails, files are too long, or other edge cases occur. This prevents the ADHD workflow from breaking on voice input.

Output: Robust voice pipeline with comprehensive error handling.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-voice-pipeline/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add duration validation</name>
  <files>COREDIRECTIVE_ENGINE/workflows/voice_handler.json</files>
  <action>
    After voice detection, validate duration:

    1. IF node: Check `message.voice.duration`
    2. If duration > 60 seconds:
       - Send message: "Voice note too long (max 60s). Please keep it brief or split into multiple messages."
       - Stop workflow
    3. If duration <= 60 seconds: Continue

    Rationale: Longer voice notes take longer to transcribe and may exceed Telegram's patience. Also enforces ADHD-friendly brevity.
  </action>
  <verify>
    # Send voice note longer than 60 seconds
    # Should receive rejection message
  </verify>
  <done>Duration validation prevents overly long voice notes</done>
</task>

<task type="auto">
  <name>Task 2: Add transcription error handling</name>
  <files>COREDIRECTIVE_ENGINE/workflows/voice_handler.json</files>
  <action>
    Wrap faster-whisper API call in error handling:

    1. Add Error Trigger node connected to HTTP Request
    2. On error:
       - Send message: "Sorry, I couldn't transcribe your voice note. Please try again or type your message."
       - Log error to PostgreSQL for debugging
    3. Set timeout: 30 seconds for transcription
       - If timeout: Treat as error

    Common errors:
    - faster-whisper container down
    - Network timeout
    - Malformed audio file
  </action>
  <verify>
    # Simulate error by stopping whisper container
    # Send voice note
    # Should receive error message, not crash
  </verify>
  <done>Transcription failures handled with user-friendly messages</done>
</task>

<task type="auto">
  <name>Task 3: Add empty transcription handling</name>
  <files>COREDIRECTIVE_ENGINE/workflows/voice_handler.json</files>
  <action>
    After transcription, validate result:

    1. IF node: Check if transcription text is empty or only whitespace
    2. If empty:
       - Send message: "I couldn't hear anything in that voice note. Try recording again in a quieter place?"
       - Stop workflow
    3. If valid text: Continue

    Edge cases:
    - Background noise only
    - Microphone muted
    - Very quiet speech
  </action>
  <verify>
    # Send silent voice note or pure background noise
    # Should receive "couldn't hear anything" message
  </verify>
  <done>Empty transcriptions caught and user notified</done>
</task>

<task type="auto">
  <name>Task 4: Add progress indicator for long transcriptions</name>
  <files>COREDIRECTIVE_ENGINE/workflows/voice_handler.json</files>
  <action>
    For voice notes > 30 seconds, add progress update:

    1. IF node: Check duration
    2. If duration > 30 seconds:
       - Send initial message: "Transcribing... (this may take a moment)"
    3. Else:
       - Send standard message: "Transcribing..."

    This manages expectations for longer voice notes.
  </action>
  <verify>
    # Send 45-second voice note
    # Should see "may take a moment" qualifier
  </verify>
  <done>Progress messaging adjusted for long voice notes</done>
</task>

<task type="auto">
  <name>Task 5: Add logging for transcription metrics</name>
  <files>COREDIRECTIVE_ENGINE/workflows/voice_handler.json</files>
  <action>
    Log transcription events to PostgreSQL:

    Table: voice_transcriptions
    Fields:
    - message_id (Telegram message ID)
    - user_id (Telegram user ID)
    - duration (audio duration in seconds)
    - transcription_time (time taken to transcribe)
    - transcription_length (character count)
    - success (boolean)
    - error_message (if failed)
    - timestamp

    This enables debugging and performance monitoring.
  </action>
  <verify>
    # Send voice note
    # Check PostgreSQL for log entry
    SELECT * FROM voice_transcriptions ORDER BY timestamp DESC LIMIT 1;
  </verify>
  <done>Transcription metrics logged to database</done>
</task>

</tasks>

<verification>
1. Test successful transcription (normal case)
2. Test voice note > 60 seconds (should reject)
3. Test with whisper container stopped (should error gracefully)
4. Test silent voice note (should detect empty transcription)
5. Test long voice note (should show extended progress message)
6. Check database logs contain all test cases
</verification>

<success_criteria>
- Duration validation rejects >60s voice notes
- Transcription errors show user-friendly messages
- Empty transcriptions detected and handled
- Progress messages adjust for duration
- All events logged to database
</success_criteria>

<output>
After completion, create `.planning/phases/06-voice-pipeline/06-04-SUMMARY.md`
</output>
