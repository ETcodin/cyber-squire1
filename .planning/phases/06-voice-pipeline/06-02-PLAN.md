---
phase: 06-voice-pipeline
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_created:
  - COREDIRECTIVE_ENGINE/workflows/voice_handler.json

must_haves:
  truths:
    - "Voice notes trigger voice detection logic"
    - "Voice files downloaded from Telegram successfully"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/voice_handler.json"
      provides: "Voice detection and download workflow"
      contains: "Telegram voice message handling"
  key_links:
    - from: "supervisor workflow"
      to: "voice_handler workflow"
      via: "Execute Workflow node"
      pattern: "message.voice exists"
---

<objective>
Implement voice note detection and file download from Telegram.

Purpose: Detect when a user sends a voice note (not text) and download the audio file for transcription. This is the first step in the voice pipeline.

Output: n8n workflow that detects voice messages and downloads .oga files from Telegram API.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-voice-pipeline/06-01-SUMMARY.md
Telegram API docs: https://core.telegram.org/bots/api#voice
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create voice detection workflow</name>
  <files>COREDIRECTIVE_ENGINE/workflows/voice_handler.json</files>
  <action>
    Create n8n workflow with:

    1. Webhook trigger (or call from supervisor workflow)
    2. IF node: Check if `message.voice` field exists
    3. Set variable: Extract `file_id` from `message.voice.file_id`
    4. HTTP Request: Call Telegram getFile API
       - URL: `https://api.telegram.org/bot{{$credentials.telegramBotToken}}/getFile?file_id={{$node["Set"].json["file_id"]}}`
       - Method: GET
    5. Set variable: Extract file_path from response
    6. HTTP Request: Download file
       - URL: `https://api.telegram.org/file/bot{{$credentials.telegramBotToken}}/{{$node["Set2"].json["file_path"]}}`
       - Method: GET
       - Response format: Binary
    7. Store binary data for next step

    Key fields to extract:
    - message.voice.file_id
    - message.voice.duration
    - message.voice.mime_type (usually "audio/ogg")

    Note: Telegram voice notes are in .oga format (Ogg container with Opus codec)
  </action>
  <verify>
    # Workflow created in n8n UI
    # Test by sending voice note to bot
    # Execution log should show file downloaded as binary data
  </verify>
  <done>voice_handler.json workflow created with download logic</done>
</task>

<task type="auto">
  <name>Task 2: Add voice detection to supervisor workflow</name>
  <files>COREDIRECTIVE_ENGINE/workflows/workflow_supervisor_agent.json</files>
  <action>
    Update supervisor workflow to route voice messages:

    1. After message intake, add IF node:
       - Condition: `{{ $json.message.voice !== undefined }}`
    2. If TRUE: Execute voice_handler workflow
    3. If FALSE: Continue to existing text routing logic

    This ensures voice notes are caught early and routed to transcription pipeline.
  </action>
  <verify>
    # Check supervisor workflow has voice detection branch
    grep -A 5 "message.voice" COREDIRECTIVE_ENGINE/workflows/workflow_supervisor_agent.json
  </verify>
  <done>Supervisor workflow routes voice messages to voice_handler</done>
</task>

<task type="auto">
  <name>Task 3: Add initial status message</name>
  <files>COREDIRECTIVE_ENGINE/workflows/voice_handler.json</files>
  <action>
    Add Telegram Send Message node immediately after voice detection:

    Message: "Transcribing your voice note..."

    This provides immediate feedback (VOICE-03 requirement) while transcription processes.

    Use chat_id from incoming message.
  </action>
  <verify>
    # Test by sending voice note
    # User should see "Transcribing..." message within 2 seconds
  </verify>
  <done>Initial status message sent immediately on voice detection</done>
</task>

</tasks>

<verification>
1. Send voice note to Telegram bot
2. Check execution log shows voice detection triggered
3. Verify file downloaded as binary data
4. Confirm "Transcribing..." message appears in Telegram within 2 seconds
</verification>

<success_criteria>
- Voice note triggers voice_handler workflow
- File downloads successfully from Telegram API
- Status message appears within 2 seconds
- Binary audio data available for next step
</success_criteria>

<output>
After completion, create `.planning/phases/06-voice-pipeline/06-02-SUMMARY.md`
</output>
