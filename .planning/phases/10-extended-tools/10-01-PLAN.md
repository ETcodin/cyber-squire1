---
phase: 10-extended-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_created:
  - COREDIRECTIVE_ENGINE/workflows/tool_finance_manager.json
  - COREDIRECTIVE_ENGINE/sql/finance_schema.sql

must_haves:
  truths:
    - "Transactions logged to database"
    - "Debt burn-down tracked against $60K goal"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/tool_finance_manager.json"
      provides: "Transaction logging and debt tracking"
      contains: "NLP transaction parsing and PostgreSQL storage"
    - path: "COREDIRECTIVE_ENGINE/sql/finance_schema.sql"
      provides: "Finance database schema"
      contains: "transactions and debt_tracking tables"
---

<objective>
Create Finance Manager tool for transaction logging and debt burn-down tracking.

Purpose: Enable friction-free expense tracking via Telegram. ADHD-friendly: no app to open, no forms to fill. Just message "Log $50 for groceries" and it's tracked.

Output: Finance commands log transactions and track progress toward $60K debt payoff goal.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create finance database schema</name>
  <files>COREDIRECTIVE_ENGINE/sql/finance_schema.sql</files>
  <action>
    Design PostgreSQL schema for transaction tracking:

    ```sql
    CREATE TABLE IF NOT EXISTS transactions (
        id SERIAL PRIMARY KEY,
        user_id BIGINT NOT NULL,
        amount DECIMAL(10, 2) NOT NULL,
        category VARCHAR(100),
        description TEXT,
        transaction_date DATE DEFAULT CURRENT_DATE,
        logged_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        is_debt_payment BOOLEAN DEFAULT false
    );

    CREATE INDEX idx_transactions_user_date ON transactions(user_id, transaction_date DESC);
    CREATE INDEX idx_transactions_category ON transactions(category);

    CREATE TABLE IF NOT EXISTS debt_tracking (
        id SERIAL PRIMARY KEY,
        total_debt DECIMAL(10, 2) NOT NULL,
        target_debt DECIMAL(10, 2) DEFAULT 0,
        current_balance DECIMAL(10, 2),
        monthly_burn_rate DECIMAL(10, 2),
        projected_payoff_date DATE,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Initialize debt tracking with $60K goal
    INSERT INTO debt_tracking (total_debt, target_debt, current_balance)
    VALUES (60000, 0, 60000)
    ON CONFLICT DO NOTHING;
    ```

    Categories:
    - Groceries
    - Rent
    - Utilities
    - Transportation
    - Entertainment
    - Debt Payment
    - Other
  </action>
  <verify>
    # Run SQL script on PostgreSQL
    # Verify tables created
    \dt transactions debt_tracking
  </verify>
  <done>Finance database schema created</done>
</task>

<task type="auto">
  <name>Task 2: Implement NLP transaction parsing</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_finance_manager.json</files>
  <action>
    Parse natural language transaction inputs:

    Input patterns:
    - "Log $50 for groceries"
    - "Spent $120 on gas"
    - "Paid $500 debt"
    - "$25 coffee"

    Parsing logic (JavaScript):
    ```javascript
    const text = $json.message.text.toLowerCase();

    // Extract amount
    const amountMatch = text.match(/\$(\d+(?:\.\d{2})?)/);
    const amount = amountMatch ? parseFloat(amountMatch[1]) : null;

    // Extract category
    const categories = ['groceries', 'rent', 'utilities', 'gas', 'transportation',
                       'entertainment', 'coffee', 'food', 'debt'];
    let category = 'Other';

    for (const cat of categories) {
      if (text.includes(cat)) {
        category = cat.charAt(0).toUpperCase() + cat.slice(1);
        break;
      }
    }

    // Check if debt payment
    const isDebtPayment = text.includes('debt') || text.includes('paid off');

    // Extract description (everything after "for" or "on")
    const descMatch = text.match(/(?:for|on)\s+(.+)/);
    const description = descMatch ? descMatch[1] : text;

    return {
      amount,
      category,
      description,
      is_debt_payment: isDebtPayment
    };
    ```

    Fallback: If parsing fails, ask user for clarification.
  </action>
  <verify>
    # Test with sample inputs
    # "Log $50 for groceries" â†’ amount: 50, category: Groceries
    # "Paid $500 debt" â†’ amount: 500, is_debt_payment: true
  </verify>
  <done>NLP parsing extracts amount, category, description</done>
</task>

<task type="auto">
  <name>Task 3: Log transaction to database</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_finance_manager.json</files>
  <action>
    Insert transaction into PostgreSQL:

    SQL:
    ```sql
    INSERT INTO transactions
    (user_id, amount, category, description, is_debt_payment)
    VALUES ($1, $2, $3, $4, $5)
    RETURNING id;
    ```

    Parameters:
    - user_id: Telegram user ID
    - amount: Parsed amount
    - category: Parsed category
    - description: Parsed description
    - is_debt_payment: Boolean flag

    After insert, send confirmation:
    ```
    âœ… Logged $50.00 for Groceries

    Description: groceries
    Date: Feb 4, 2026
    ```

    This satisfies TOOL-03 requirement (SC-10.1).
  </action>
  <verify>
    # Send "Log $50 for groceries"
    # Verify confirmation message
    # Check database has new row
    SELECT * FROM transactions ORDER BY logged_at DESC LIMIT 1;
  </verify>
  <done>Transactions logged to database with confirmation</done>
</task>

<task type="auto">
  <name>Task 4: Implement debt burn-down calculation</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_finance_manager.json</files>
  <action>
    Calculate debt status and burn rate:

    SQL query:
    ```sql
    -- Total debt payments in last 30 days
    SELECT SUM(amount) as total_paid
    FROM transactions
    WHERE is_debt_payment = true
    AND transaction_date > CURRENT_DATE - INTERVAL '30 days';

    -- Monthly burn rate (average over 3 months)
    SELECT AVG(monthly_total) as burn_rate
    FROM (
      SELECT SUM(amount) as monthly_total
      FROM transactions
      WHERE is_debt_payment = true
      GROUP BY DATE_TRUNC('month', transaction_date)
      ORDER BY DATE_TRUNC('month', transaction_date) DESC
      LIMIT 3
    ) as monthly;

    -- Current balance
    SELECT
      dt.total_debt - COALESCE(SUM(t.amount), 0) as current_balance
    FROM debt_tracking dt
    LEFT JOIN transactions t ON t.is_debt_payment = true;
    ```

    Calculate projected payoff:
    ```javascript
    const currentBalance = 60000 - totalPaid;
    const monthlyBurnRate = burnRateAvg;
    const monthsRemaining = currentBalance / monthlyBurnRate;
    const payoffDate = new Date();
    payoffDate.setMonth(payoffDate.getMonth() + Math.ceil(monthsRemaining));

    return {
      current_balance: currentBalance,
      monthly_burn_rate: monthlyBurnRate,
      projected_payoff_date: payoffDate.toISOString().split('T')[0]
    };
    ```

    Update debt_tracking table with latest calculations.
  </action>
  <verify>
    # Log several debt payments
    # Check burn rate calculation
    # Verify projected payoff date reasonable
  </verify>
  <done>Debt burn-down calculation with projection</done>
</task>

<task type="auto">
  <name>Task 5: Format debt status response</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_finance_manager.json</files>
  <action>
    Create "Debt status" command response:

    Template:
    ```
    **Debt Burn-Down Status**

    ðŸ’° Current balance: **${{current_balance}}**
    ðŸ“‰ Monthly burn rate: **${{burn_rate}}/month**
    ðŸŽ¯ Target: **$0** ({{target_debt}})
    ðŸ“… Projected payoff: **{{payoff_date}}**

    **Progress:** {{progress_percentage}}% complete
    [â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘] {{progress_bar}}

    **Next step:** Keep up the momentum!
    ```

    Progress bar calculation:
    ```javascript
    const progress = (1 - (currentBalance / 60000)) * 100;
    const filled = Math.floor(progress / 10);
    const bar = 'â–“'.repeat(filled) + 'â–‘'.repeat(10 - filled);

    return { progress_percentage: progress.toFixed(1), progress_bar: bar };
    ```

    This satisfies TOOL-03 requirement (SC-10.2).

    Apply ADHD formatting:
    - Bold numbers
    - Visual progress bar
    - Clear next step
  </action>
  <verify>
    # Send "Debt status"
    # Verify formatted response with progress bar
    # Check numbers accurate
  </verify>
  <done>Debt status formatted with visual progress</done>
</task>

<task type="auto">
  <name>Task 6: Add spending summary command</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_finance_manager.json</files>
  <action>
    Create "Spending summary" command:

    SQL query:
    ```sql
    -- Last 7 days spending by category
    SELECT
      category,
      COUNT(*) as transaction_count,
      SUM(amount) as total_spent
    FROM transactions
    WHERE transaction_date > CURRENT_DATE - INTERVAL '7 days'
    AND is_debt_payment = false
    GROUP BY category
    ORDER BY total_spent DESC
    LIMIT 5;

    -- Total spending last 7 days
    SELECT SUM(amount) as total
    FROM transactions
    WHERE transaction_date > CURRENT_DATE - INTERVAL '7 days'
    AND is_debt_payment = false;
    ```

    Response format:
    ```
    **Spending Summary (Last 7 Days)**

    Total: **${{total}}**

    Top categories:
    â€¢ Groceries: $120 (3 transactions)
    â€¢ Transportation: $80 (2 transactions)
    â€¢ Entertainment: $45 (1 transaction)

    **Next step:** Review categories to find savings opportunities
    ```

    Max 3 categories (ADHD formatting).
  </action>
  <verify>
    # Log several transactions across categories
    # Send "Spending summary"
    # Verify top 3 categories shown
  </verify>
  <done>Spending summary shows top categories</done>
</task>

</tasks>

<verification>
1. Send "Log $50 for groceries" â†’ verify confirmation
2. Send "Paid $500 debt" â†’ verify logged as debt payment
3. Send "Debt status" â†’ verify balance and projection
4. Send "Spending summary" â†’ verify category breakdown
5. Check database for all logged transactions
6. Verify burn rate calculation accurate
</verification>

<success_criteria>
- "Log $X for Y" creates transaction (SC-10.1)
- "Debt status" shows balance and burn rate (SC-10.2)
- Projected payoff date calculated correctly
- Spending summary shows top categories
- All responses use ADHD formatting
</success_criteria>

<output>
After completion, create `.planning/phases/10-extended-tools/10-01-SUMMARY.md`
</output>
