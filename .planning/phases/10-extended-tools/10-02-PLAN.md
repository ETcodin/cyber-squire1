---
phase: 10-extended-tools
plan: 02
type: execute
wave: 2
depends_on: []
files_created:
  - COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json
  - COREDIRECTIVE_ENGINE/sql/security_whitelist.sql

must_haves:
  truths:
    - "Scans restricted to whitelisted targets only"
    - "Confirmation required before execution"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json"
      provides: "Security scanning with confirmation"
      contains: "Nmap/Nuclei integration and target validation"
    - path: "COREDIRECTIVE_ENGINE/sql/security_whitelist.sql"
      provides: "Target whitelist schema"
      contains: "allowed_targets table"
---

<objective>
Create Security Scan tool with target whitelisting and confirmation flow.

Purpose: Enable quick security scans via Telegram while preventing accidental scanning of unauthorized targets. Combines convenience with safety.

Output: "Scan example.com" runs Nmap/Nuclei after confirmation, only on whitelisted targets.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-interactive-ui/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create target whitelist schema</name>
  <files>COREDIRECTIVE_ENGINE/sql/security_whitelist.sql</files>
  <action>
    Design PostgreSQL schema for allowed scan targets:

    ```sql
    CREATE TABLE IF NOT EXISTS allowed_scan_targets (
        id SERIAL PRIMARY KEY,
        target VARCHAR(255) UNIQUE NOT NULL,
        description TEXT,
        owner VARCHAR(100),
        added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        last_scanned TIMESTAMP
    );

    CREATE INDEX idx_targets_lookup ON allowed_scan_targets(target);

    -- Pre-populate with known targets
    INSERT INTO allowed_scan_targets (target, description, owner)
    VALUES
        ('tigouetheory.com', 'Primary domain', 'tigoue'),
        ('cyber-squire.tigouetheory.com', 'n8n subdomain', 'tigoue'),
        ('54.234.155.244', 'EC2 instance', 'tigoue')
    ON CONFLICT (target) DO NOTHING;

    CREATE TABLE IF NOT EXISTS scan_history (
        id SERIAL PRIMARY KEY,
        target VARCHAR(255) NOT NULL,
        scan_type VARCHAR(50) NOT NULL,
        started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        completed_at TIMESTAMP,
        status VARCHAR(20),
        findings_count INTEGER,
        results JSONB,
        user_id BIGINT
    );

    CREATE INDEX idx_scan_history_target ON scan_history(target, started_at DESC);
    ```

    This satisfies TOOL-04 requirement (SC-10.5: whitelist restriction).
  </action>
  <verify>
    # Run SQL script
    # Verify tables created
    # Check whitelist has initial targets
    SELECT * FROM allowed_scan_targets;
  </verify>
  <done>Security whitelist schema created</done>
</task>

<task type="auto">
  <name>Task 2: Implement target validation</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json</files>
  <action>
    Parse scan request and validate target:

    Input patterns:
    - "Scan example.com"
    - "Security scan 54.234.155.244"
    - "Nmap tigouetheory.com"

    Parsing logic:
    ```javascript
    const text = $json.message.text;

    // Extract target (domain or IP)
    const targetMatch = text.match(/(?:scan|nmap)\s+([a-zA-Z0-9.-]+)/i);
    const target = targetMatch ? targetMatch[1] : null;

    if (!target) {
      return { error: 'No target specified. Usage: scan <domain or IP>' };
    }

    return { target };
    ```

    Validation SQL:
    ```sql
    SELECT COUNT(*) as is_allowed
    FROM allowed_scan_targets
    WHERE target = $1;
    ```

    If is_allowed = 0:
    - Send error: "‚õî Target {{target}} is not whitelisted. Contact admin to add it."
    - Stop workflow

    If is_allowed = 1:
    - Continue to confirmation step

    This satisfies TOOL-04 requirement (SC-10.5).
  </action>
  <verify>
    # Send "Scan unauthorized.com"
    # Verify rejection message
    # Send "Scan tigouetheory.com"
    # Verify passes validation
  </verify>
  <done>Target validation rejects non-whitelisted targets</done>
</task>

<task type="auto">
  <name>Task 3: Add confirmation flow with button</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json</files>
  <action>
    After validation, show confirmation buttons:

    From Phase 8 button templates:
    ```javascript
    Execute Workflow: button_templates
    Input: {
      template_type: "yes_no",
      action_prefix: "confirm_scan",
      params: [target]
    }
    ```

    Send message with buttons:
    ```
    Confirm scan of **{{target}}**?

    Scan type: Nmap port scan + Nuclei vulnerability check
    Estimated time: 2-5 minutes

    [ ‚úÖ Yes ] [ ‚ùå No ]
    ```

    Workflow pauses here waiting for callback.

    On yes_confirm_scan callback:
    - Proceed to scan execution
    - Send "üîç Scanning {{target}}..."

    On no_confirm_scan callback:
    - Send "Scan cancelled"
    - Stop workflow

    This satisfies TOOL-04 requirement (SC-10.3: confirmation before scan).
  </action>
  <verify>
    # Send "Scan tigouetheory.com"
    # Verify confirmation buttons appear
    # Click Yes and verify scan starts
    # Test again, click No and verify cancellation
  </verify>
  <done>Confirmation flow prevents accidental scans</done>
</task>

<task type="auto">
  <name>Task 4: Implement Nmap scan execution</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json</files>
  <action>
    Run Nmap via SSH to EC2:

    SSH Execute Command:
    ```bash
    nmap -sV -T4 --top-ports 100 {{target}} -oX -
    ```

    Parameters:
    - `-sV`: Service version detection
    - `-T4`: Faster timing (aggressive)
    - `--top-ports 100`: Scan most common 100 ports
    - `-oX -`: XML output to stdout

    Parse XML output to extract:
    - Open ports
    - Services detected
    - Versions

    Timeout: 5 minutes (some scans take time)

    Note: Nmap should already be installed on EC2.
    If not: `sudo yum install nmap -y`
  </action>
  <verify>
    # Confirm scan of whitelisted target
    # Verify Nmap executes on EC2
    # Check output contains port information
  </verify>
  <done>Nmap scan executes and returns results</done>
</task>

<task type="auto">
  <name>Task 5: Implement Nuclei vulnerability scan</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json</files>
  <action>
    Run Nuclei for vulnerability scanning:

    SSH Execute Command:
    ```bash
    nuclei -u https://{{target}} -severity critical,high -json -silent
    ```

    Parameters:
    - `-u`: Target URL
    - `-severity critical,high`: Only critical/high findings
    - `-json`: JSON output
    - `-silent`: Reduce noise

    Parse JSON output to extract:
    - Vulnerability name
    - Severity
    - Matched template
    - Affected URL

    Timeout: 5 minutes

    Note: Install Nuclei if not present:
    ```bash
    curl -L https://github.com/projectdiscovery/nuclei/releases/latest/download/nuclei_3.x.x_linux_amd64.zip -o nuclei.zip
    unzip nuclei.zip
    sudo mv nuclei /usr/local/bin/
    ```

    Rate limiting:
    - Add `-rate-limit 10` to prevent overwhelming target
    - Only scan whitelisted targets (prevents abuse)
  </action>
  <verify>
    # Confirm scan
    # Verify Nuclei executes
    # Check JSON output parsed correctly
  </verify>
  <done>Nuclei scan executes for vulnerability detection</done>
</task>

<task type="auto">
  <name>Task 6: Format scan results with severity indicators</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json</files>
  <action>
    Combine Nmap + Nuclei results into formatted response:

    Template:
    ```
    **Security Scan Results: {{target}}**

    **Port Scan (Nmap):**
    {{#if open_ports}}
    {{#each open_ports}}
    ‚Ä¢ Port {{port}}: {{service}} ({{version}})
    {{/each}}
    {{else}}
    ‚Ä¢ No open ports detected in top 100
    {{/if}}

    **Vulnerabilities (Nuclei):**
    {{#if vulnerabilities}}
    {{#each vulnerabilities}}
    {{severity_icon}} **{{name}}** ({{severity}})
      Affected: {{url}}
    {{/each}}
    {{else}}
    ‚úÖ No critical/high vulnerabilities found
    {{/if}}

    Scan completed: {{timestamp}}
    ```

    Severity indicators (SC-10.4):
    - üî¥ Critical
    - üü† High
    - üü° Medium
    - üü¢ Low

    ADHD formatting:
    - Bold vulnerability names
    - Max 3 vulnerabilities shown (if more: "... and X more")
    - Color-coded severity

    Store full results in scan_history table.
  </action>
  <verify>
    # Complete full scan
    # Verify formatted results with severity icons
    # Check ADHD formatting applied (max 3 items)
  </verify>
  <done>Scan results formatted with severity indicators</done>
</task>

<task type="auto">
  <name>Task 7: Add rate limiting for scans</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_security_scan.json</files>
  <action>
    Prevent scan abuse with rate limiting:

    Check last scan time:
    ```sql
    SELECT MAX(started_at) as last_scan
    FROM scan_history
    WHERE target = $1
    AND user_id = $2;
    ```

    Rate limit rules:
    - Max 1 scan per target per hour
    - Max 5 total scans per user per day

    If rate limit exceeded:
    ```
    ‚è±Ô∏è Rate limit: You scanned {{target}} {{minutes_ago}} minutes ago.
    Please wait {{wait_time}} before scanning again.
    ```

    This prevents:
    - Accidental duplicate scans
    - Excessive resource usage
    - Potential abuse

    Admin override: Specific user IDs can bypass limits
  </action>
  <verify>
    # Scan target twice within 1 hour
    # Verify second scan blocked with rate limit message
  </verify>
  <done>Rate limiting prevents scan abuse</done>
</task>

</tasks>

<verification>
1. Send "Scan unauthorized.com" ‚Üí verify rejected
2. Send "Scan tigouetheory.com" ‚Üí verify confirmation appears
3. Click Yes ‚Üí verify scan executes
4. Verify Nmap results show open ports
5. Verify Nuclei results show vulnerabilities (if any)
6. Verify severity indicators (üî¥ üü†) appear
7. Scan same target again immediately ‚Üí verify rate limit
8. Check scan_history table has logged scan
</verification>

<success_criteria>
- Confirmation button required before scan (SC-10.3)
- Scan results formatted with severity indicators (SC-10.4)
- Only whitelisted targets allowed (SC-10.5)
- Rate limiting prevents abuse
- Results stored in scan_history
- ADHD formatting applied to results
</success_criteria>

<output>
After completion, create `.planning/phases/10-extended-tools/10-02-SUMMARY.md`
</output>
