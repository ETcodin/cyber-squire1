---
phase: 07-output-formatting
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_created:
  - COREDIRECTIVE_ENGINE/workflows/format_tldr_expandable.json

must_haves:
  truths:
    - "Long responses show TL;DR first"
    - "Expandable details available via button"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/format_tldr_expandable.json"
      provides: "TL;DR summary with expandable workflow"
      contains: "Summary extraction and spoiler tags"
---

<objective>
Implement TL;DR summaries with expandable details for long responses.

Purpose: Prevent information overload by showing summary first with option to expand. Critical for ADHD users who need to triage information quickly.

Output: Workflow that generates TL;DR and hides full details behind Telegram spoiler/expandable UI.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/07-output-formatting/07-01-SUMMARY.md
Telegram spoiler docs: https://core.telegram.org/bots/api#markdownv2-style
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define length threshold for TL;DR</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_tldr_expandable.json</files>
  <action>
    Create workflow with length check:

    1. IF node: Check if response length > 300 characters
    2. If TRUE: Generate TL;DR + expandable details
    3. If FALSE: Use standard formatting (from 07-01)

    Rationale: 300 characters ≈ 2-3 sentences
    - Below threshold: Short enough to read at once
    - Above threshold: Needs summarization

    Configuration:
    - threshold_characters: 300
    - max_tldr_length: 100 (keep summary very brief)
  </action>
  <verify>
    # Test with 250-char message: should use standard format
    # Test with 400-char message: should generate TL;DR
  </verify>
  <done>Length threshold separates short vs long responses</done>
</task>

<task type="auto">
  <name>Task 2: Generate TL;DR summary via AI</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_tldr_expandable.json</files>
  <action>
    Add AI Agent node to summarize long responses:

    Prompt:
    ```
    Summarize this response in ONE sentence (max 100 characters):

    {full_response}

    Focus on: the main point, action needed, or status change.
    Format: Plain text, no markdown, no emojis.
    ```

    Use Ollama (fast, local) for summarization.
    Fallback to simple truncation if Ollama fails:
    - Take first sentence
    - Truncate to 100 chars
    - Add "..." if truncated

    Example:
    Input: "The system health check shows all services running normally. PostgreSQL is at 45% memory usage, n8n has processed 1,234 workflows today, and Ollama responded in 2.3 seconds. No critical alerts detected."

    TL;DR: "All systems healthy, no alerts"
  </action>
  <verify>
    # Test with long technical response
    # TL;DR should be <100 chars and capture main point
  </verify>
  <done>AI-generated TL;DR summarizes main point</done>
</task>

<task type="auto">
  <name>Task 3: Format expandable details with Telegram spoiler</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_tldr_expandable.json</files>
  <action>
    Use Telegram spoiler syntax for expandable details:

    MarkdownV2 format:
    ```
    **TL;DR:** {summary}

    ||{full_details}||
    ```

    The || syntax creates spoiler text that's hidden until tapped.

    Alternative using HTML:
    ```html
    <b>TL;DR:</b> {summary}

    <tg-spoiler>{full_details}</tg-spoiler>
    ```

    User experience:
    1. Sees TL;DR immediately
    2. Taps spoiler to reveal full details
    3. Can quickly triage without reading everything

    Note: Spoiler text appears as gray box in Telegram, tapping reveals content
  </action>
  <verify>
    # Send formatted message to Telegram
    # Verify TL;DR visible, details hidden behind spoiler
  </verify>
  <done>Expandable details use Telegram spoiler syntax</done>
</task>

<task type="auto">
  <name>Task 4: Apply ADHD formatting to both summary and details</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_tldr_expandable.json</files>
  <action>
    Call format_adhd_response workflow for both parts:

    1. Format TL;DR:
       - Bold key status words
       - Keep very brief (1 sentence)

    2. Format full details:
       - Apply all ADHD formatting (from 07-01)
       - Bold keywords
       - Truncate bullets to 3
       - Add next-step line

    This ensures both summary and expanded view are ADHD-friendly.

    Workflow flow:
    Input → Length check → Generate TL;DR → Format TL;DR → Format details → Assemble final message
  </action>
  <verify>
    # Expand spoiler in Telegram
    # Full details should have bold keywords and truncated bullets
  </verify>
  <done>Both TL;DR and details use ADHD formatting</done>
</task>

<task type="auto">
  <name>Task 5: Add footer hint for expandable messages</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_tldr_expandable.json</files>
  <action>
    Add helpful hint after TL;DR:

    Format:
    ```
    **TL;DR:** {summary}

    (Tap gray box below for details)

    ||{full_details}||
    ```

    First-time users may not know Telegram spoiler syntax.
    Small hint improves discoverability.

    After user sees expandable format 3 times, could hide the hint.
    Track in database: user_preferences.seen_expandable_hint
  </action>
  <verify>
    # Send expandable message to Telegram
    # Hint should guide user to tap spoiler
  </verify>
  <done>Helpful hint guides users to expand details</done>
</task>

</tasks>

<verification>
1. Test short message (200 chars): uses standard format
2. Test long message (500 chars): uses TL;DR + expandable
3. Verify TL;DR <100 chars and captures main point
4. Verify spoiler hides details until tapped
5. Verify expanded details have ADHD formatting
6. Verify hint appears for guidance
</verification>

<success_criteria>
- Messages >300 chars show TL;DR
- TL;DR <100 chars
- Details hidden behind spoiler
- Expanded details have ADHD formatting
- Hint guides users to tap spoiler
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-formatting/07-02-SUMMARY.md`
</output>
