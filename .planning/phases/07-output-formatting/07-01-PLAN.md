---
phase: 07-output-formatting
plan: 01
type: execute
wave: 1
depends_on: []
files_created:
  - COREDIRECTIVE_ENGINE/workflows/format_adhd_response.json

must_haves:
  truths:
    - "All responses have bold keywords for scanning"
    - "Bullet lists never exceed 3 items"
    - "Actionable responses end with 'Next step:' line"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/format_adhd_response.json"
      provides: "ADHD formatting utility workflow"
      contains: "Bold keywords, bullet truncation, next-step extraction"
---

<objective>
Create ADHD-optimized formatting utility for all Telegram responses.

Purpose: Transform AI-generated responses into ADHD-friendly format with bold keywords, max 3 bullets, and clear next steps. This prevents overwhelming wall-of-text responses that cause task abandonment.

Output: Reusable formatting workflow that can be called by any sub-workflow.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ADHD_FORMATTING_RESEARCH.md (if exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatting workflow structure</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_adhd_response.json</files>
  <action>
    Create n8n workflow with:

    Input parameters:
    - raw_text: The unformatted AI response
    - response_type: "informational" | "actionable" | "error"

    Output:
    - formatted_text: ADHD-optimized Telegram message (Markdown/HTML)

    Workflow nodes:
    1. Webhook/Execute trigger (for calling from other workflows)
    2. Input validation
    3. Bold keyword extraction
    4. Bullet truncation
    5. Next-step extraction
    6. HTML/Markdown assembly
    7. Return formatted text

    Note: Use Execute Workflow node from parent workflows
  </action>
  <verify>
    # Workflow created in n8n
    # Can be triggered from other workflows
  </verify>
  <done>format_adhd_response.json workflow structure created</done>
</task>

<task type="auto">
  <name>Task 2: Implement bold keyword extraction</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_adhd_response.json</files>
  <action>
    Add Code node to identify and bold key terms:

    Logic:
    1. Extract important words (nouns, verbs, numbers)
    2. Bold 2-5 keywords per paragraph using **keyword** syntax
    3. Prioritize: action verbs, specific numbers, critical status words

    JavaScript example:
    ```javascript
    const text = $input.item.json.raw_text;
    const keywords = ['ready', 'complete', 'failed', 'running', 'error'];

    let formatted = text;
    keywords.forEach(keyword => {
      const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
      formatted = formatted.replace(regex, `**${keyword}**`);
    });

    return { formatted_text: formatted };
    ```

    For dynamic keyword extraction, could use AI or simple heuristics:
    - ALL CAPS words
    - Numbers with units (e.g., "16GB", "5 seconds")
    - Status words (healthy, failed, warning, critical)
  </action>
  <verify>
    # Test input: "The system is running with 16GB RAM available"
    # Expected output: "The system is **running** with **16GB** RAM available"
  </verify>
  <done>Bold keyword extraction implemented</done>
</task>

<task type="auto">
  <name>Task 3: Implement bullet truncation</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_adhd_response.json</files>
  <action>
    Add Code node to limit bullet lists to 3 items:

    Logic:
    1. Detect bullet lists (lines starting with -, *, ‚Ä¢, or numbers)
    2. If list > 3 items:
       - Keep top 3 items
       - Add "... and X more" footer
       - OR prioritize by importance (if AI-ranked)
    3. Format with emoji bullets for visual distinction

    JavaScript example:
    ```javascript
    const lines = text.split('\n');
    const bullets = lines.filter(line => line.match(/^[-*‚Ä¢]\s/));

    if (bullets.length > 3) {
      const top3 = bullets.slice(0, 3);
      const remaining = bullets.length - 3;
      return top3.join('\n') + `\n... and ${remaining} more`;
    }

    return bullets.join('\n');
    ```

    ADHD-friendly bullet formatting:
    - ‚úÖ Action completed
    - ‚ö†Ô∏è Warning/attention needed
    - ‚ùå Error/failed
    - üìä Status/metric
  </action>
  <verify>
    # Test input: 7-item bullet list
    # Expected output: Top 3 items + "... and 4 more"
  </verify>
  <done>Bullet truncation limits lists to 3 items max</done>
</task>

<task type="auto">
  <name>Task 4: Implement next-step extraction</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_adhd_response.json</files>
  <action>
    Add Code node to extract next action step:

    Logic:
    1. Look for action-oriented sentence in AI response
    2. If response_type = "actionable":
       - Extract the most immediate action
       - Format as: "**Next step:** [action]"
    3. If no clear action found:
       - Omit next-step line (not all messages need it)

    Heuristics for identifying next step:
    - Imperative verbs (Run, Check, Update, Create)
    - Phrases: "you should", "next", "then", "to fix"
    - Last sentence if it's a command

    Example:
    Input: "The system is healthy. You should check the logs for warnings."
    Output appends: "**Next step:** Check the logs for warnings"
  </action>
  <verify>
    # Test with actionable response
    # Should end with "Next step: [specific action]"
  </verify>
  <done>Next-step extraction adds clear call-to-action</done>
</task>

<task type="auto">
  <name>Task 5: Assemble final formatted output</name>
  <files>COREDIRECTIVE_ENGINE/workflows/format_adhd_response.json</files>
  <action>
    Add final assembly node:

    Template:
    ```
    {bolded_text}

    {truncated_bullets}

    {next_step_line}
    ```

    Telegram formatting:
    - Use parse_mode: "MarkdownV2" or "HTML"
    - HTML is more reliable for complex formatting
    - Escape special characters in MarkdownV2

    HTML example:
    ```html
    <b>Keyword</b> for bold
    ‚Ä¢ Item 1
    ‚Ä¢ Item 2
    ‚Ä¢ Item 3

    <b>Next step:</b> Action here
    ```

    Return as single string ready for Telegram Send Message node.
  </action>
  <verify>
    # Test complete workflow with sample AI response
    # Output should have all ADHD formatting elements
  </verify>
  <done>Final formatted output assembled for Telegram</done>
</task>

</tasks>

<verification>
1. Test with sample responses (informational, actionable, error)
2. Verify keywords bolded (2-5 per message)
3. Verify bullet lists truncated to 3 items
4. Verify next-step line on actionable messages
5. Send to Telegram to verify rendering
</verification>

<success_criteria>
- Keywords bolded in all responses
- Bullet lists max 3 items
- Next-step line on actionable messages
- Output renders correctly in Telegram
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-formatting/07-01-SUMMARY.md`
</output>
