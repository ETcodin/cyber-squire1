---
phase: 08-interactive-ui
plan: 03
type: execute
wave: 3
depends_on: [08-02]
files_modified:
  - COREDIRECTIVE_ENGINE/workflows/callback_handler.json
  - Multiple sub-workflows (security scan, task management, etc.)

must_haves:
  truths:
    - "Destructive actions require Yes/No confirmation"
    - "Button clicks execute correct workflows"
  artifacts:
    - path: "Various sub-workflow files"
      provides: "Button integrations in all tools"
      contains: "Yes/No confirmations and priority selectors"
---

<objective>
Integrate button templates into existing workflows for critical actions.

Purpose: Retrofit all workflows that perform destructive or important actions with confirmation buttons. This prevents accidental execution and improves user control.

Output: All critical workflows use interactive buttons for confirmations.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-interactive-ui/08-01-SUMMARY.md
@.planning/phases/08-interactive-ui/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confirmation to Security Scan workflow</name>
  <files>COREDIRECTIVE_ENGINE/workflows/workflow_tool_security_scan.json</files>
  <action>
    Update security scan workflow:

    Before:
    - User: "Scan example.com"
    - Bot: *immediately runs scan*

    After:
    - User: "Scan example.com"
    - Bot: "Confirm scan of example.com?" [ ‚úÖ Yes ] [ ‚ùå No ]
    - User: *clicks Yes*
    - Bot: *runs scan*

    Implementation:
    1. After target validation, instead of running scan:
       - Execute button_templates workflow
       - template_type: "yes_no"
       - action_prefix: "confirm_scan"
       - params: [target]
    2. Send message with buttons
    3. Wait for callback (workflow pauses here)
    4. On yes_confirm_scan callback: Execute scan
    5. On no_confirm_scan callback: Send "Scan cancelled"

    This satisfies TOOL-04 requirement (scan confirmation).
  </action>
  <verify>
    # Send "Scan example.com"
    # Verify confirmation buttons appear
    # Click Yes
    # Verify scan executes
  </verify>
  <done>Security scan requires Yes/No confirmation</done>
</task>

<task type="auto">
  <name>Task 2: Add priority selector to task creation</name>
  <files>COREDIRECTIVE_ENGINE/workflows/workflow_tool_create_task.json</files>
  <action>
    Update task creation workflow to ask for priority:

    Flow:
    - User: "Add task: Implement feature X"
    - Bot: "Task created. Set priority:" [ üî¥ High ] [ üü° Medium ] [ üü¢ Low ]
    - User: *clicks High*
    - Bot: "Task added with High priority"

    Implementation:
    1. After creating task in Notion:
       - Execute button_templates workflow
       - template_type: "priority_selector"
       - action_prefix: "set_task_priority"
       - params: [task_id]
    2. Send message with priority buttons
    3. On callback: Update task priority in Notion
    4. Confirm priority set

    This satisfies FORMAT-03 requirement (priority selector).
  </action>
  <verify>
    # Create task via Telegram
    # Verify priority buttons appear
    # Click Medium
    # Verify task updated in Notion with Medium priority
  </verify>
  <done>Task creation includes priority selector</done>
</task>

<task type="auto">
  <name>Task 3: Add confirmation to destructive operations</name>
  <files>Various workflow files</files>
  <action>
    Identify and add confirmations to destructive operations:

    Operations requiring confirmation:
    - Delete task
    - Delete workflow
    - Clear database
    - Reset configuration
    - Restart services
    - Update credentials

    Pattern for each:
    1. Detect destructive intent from user message
    2. Show confirmation: "This will [action]. Proceed?" [ ‚úÖ Yes ] [ ‚ùå No ]
    3. On Yes: Execute action + confirmation message
    4. On No: Send "Action cancelled"

    Example for "Delete task":
    ```
    User: "Delete task 123"
    Bot: "This will permanently delete task 123. Proceed?" [Yes] [No]
    User: *clicks Yes*
    Bot: "Task 123 deleted"
    ```

    Note: List of destructive operations may expand over time
  </action>
  <verify>
    # Test each destructive operation
    # Verify confirmation appears
    # Test both Yes and No paths
  </verify>
  <done>All destructive operations require confirmation</done>
</task>

<task type="auto">
  <name>Task 4: Implement callback routing for new actions</name>
  <files>COREDIRECTIVE_ENGINE/workflows/callback_handler.json</files>
  <action>
    Update callback_handler routing to handle new actions:

    New routing cases:
    - yes_confirm_scan / no_confirm_scan
    - set_task_priority (high/medium/low)
    - yes_delete_* / no_delete_* (generic delete confirmation)

    For each action:
    1. Parse callback data
    2. Extract params
    3. Execute appropriate sub-workflow
    4. Send result message

    Example:
    ```javascript
    switch (action) {
      case 'yes_confirm_scan':
        // Execute security scan workflow with params[0] as target
        break;
      case 'set_task_priority':
        // Update task priority: params[0]=priority, params[1]=task_id
        break;
      case 'yes_delete_task':
        // Delete task: params[0]=task_id
        break;
      case 'no_confirm_scan':
      case 'no_delete_task':
        // Send cancellation message
        break;
    }
    ```
  </action>
  <verify>
    # Test each new callback action
    # Verify correct sub-workflow executes
    # Verify params passed correctly
  </verify>
  <done>Callback handler routes all new button actions</done>
</task>

<task type="auto">
  <name>Task 5: Add button analytics</name>
  <files>COREDIRECTIVE_ENGINE/workflows/callback_handler.json</files>
  <action>
    Extend button logging to track user decisions:

    Additional analytics:
    - Confirmation rate (% of users who click Yes)
    - Priority distribution (how often each priority selected)
    - Time to decision (seconds between message and button click)
    - Abandoned confirmations (buttons shown but not clicked)

    SQL updates:
    ```sql
    -- Add to button_interactions table
    ALTER TABLE button_interactions
    ADD COLUMN decision VARCHAR(10), -- 'yes', 'no', 'high', 'medium', 'low'
    ADD COLUMN time_to_decision INTEGER; -- seconds

    -- Analytics query
    SELECT
      action,
      decision,
      COUNT(*) as count,
      AVG(time_to_decision) as avg_decision_time
    FROM button_interactions
    WHERE timestamp > NOW() - INTERVAL '7 days'
    GROUP BY action, decision;
    ```

    This data helps refine button UX over time.
  </action>
  <verify>
    # Click various buttons
    # Run analytics query
    # Verify decision patterns tracked
  </verify>
  <done>Button analytics track user decision patterns</done>
</task>

</tasks>

<verification>
1. Test security scan confirmation flow (Yes and No)
2. Test task priority selector (all 3 priorities)
3. Test destructive operation confirmation
4. Verify all callbacks route correctly
5. Check analytics data in database
</verification>

<success_criteria>
- Security scan requires confirmation (SC-8.1, SC-10.3)
- Priority selector works for task creation (SC-8.3)
- All destructive operations require confirmation
- Callback routing handles all button types (SC-8.2)
- Button analytics tracked in database
</success_criteria>

<output>
After completion, create `.planning/phases/08-interactive-ui/08-03-SUMMARY.md`
</output>
