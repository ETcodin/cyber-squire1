---
phase: 01-infrastructure-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - COREDIRECTIVE_ENGINE/workflow_error_handler.json
autonomous: true

must_haves:
  truths:
    - "Any workflow error triggers Telegram alert within 60 seconds"
    - "Error alert includes workflow name, error message, and timestamp"
    - "Error handler uses n8n credentials, not hardcoded tokens"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflow_error_handler.json"
      provides: "Global error handler workflow"
      contains: "credentials"
  key_links:
    - from: "workflow_error_handler.json"
      to: "n8n Telegram credential"
      via: "credential reference"
      pattern: "telegramApi"
    - from: "n8n error trigger"
      to: "Telegram sendMessage"
      via: "Format Error node"
---

<objective>
Update the error handler workflow to use n8n credential system and proper chat ID, then deploy as global error handler.

Purpose: Silent failures are catastrophic for ADHD users. When something breaks, immediate Telegram notification ensures awareness and prevents "is it broken?" analysis paralysis.

Output: Working error handler workflow deployed to n8n, using credential references (not hardcoded tokens).
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md (Section 8: Error Cascades When One Service Fails)
@COREDIRECTIVE_ENGINE/workflow_error_handler.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update error handler workflow JSON</name>
  <files>COREDIRECTIVE_ENGINE/workflow_error_handler.json</files>
  <action>
    The current workflow_error_handler.json has two issues:
    1. Line 14: `'YOUR_CHAT_ID'` placeholder needs to be replaced with expression `={{ $vars.TELEGRAM_CHAT_ID }}`
    2. Lines 24-25: Hardcoded Telegram bot token URL needs to use n8n Telegram credential

    Replace the current "Send Alert" node (httpRequest) with a proper Telegram node:

    Current (BAD - hardcoded):
    ```json
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot<TOKEN_IN_N8N_CREDENTIALS>/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "name": "Send Alert",
      "type": "n8n-nodes-base.httpRequest",
      ...
    }
    ```

    Replace with (GOOD - credential reference):
    ```json
    {
      "parameters": {
        "chatId": "={{ $vars.TELEGRAM_CHAT_ID }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [680, 300],
      "id": "send-alert",
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-creds",
          "name": "Telegram Bot"
        }
      }
    }
    ```

    Also update the "Format Error" node to use the variable:
    - Change `chat_id: 'YOUR_CHAT_ID'` to `chat_id: undefined` (not needed, Telegram node handles it)
    - Or remove chat_id from the return object entirely since the Telegram node specifies it
  </action>
  <verify>
    grep -E "api.telegram.org|YOUR_CHAT_ID" COREDIRECTIVE_ENGINE/workflow_error_handler.json
    # Should return NO matches (empty output)

    grep "telegramApi" COREDIRECTIVE_ENGINE/workflow_error_handler.json
    # Should return credential reference
  </verify>
  <done>workflow_error_handler.json uses credential reference, no hardcoded token or placeholder chat ID</done>
</task>

<task type="auto">
  <name>Task 2: Create n8n Telegram credential and variable</name>
  <files>None (n8n UI/API configuration)</files>
  <action>
    Two items must be configured in n8n before deploying the workflow:

    **1. Create Telegram API Credential:**
    Via n8n API (or UI):
    - Type: `telegramApi`
    - Name: `Telegram Bot`
    - Access Token: (retrieve from existing workflow or n8n credential store)

    The token exists in the current workflows - it should be migrated to a credential, not duplicated.

    **2. Create n8n Variable:**
    Via n8n Settings > Variables:
    - Name: `TELEGRAM_CHAT_ID`
    - Value: The user's personal Telegram chat ID (numeric)

    To find chat ID: Check existing workflow executions or use @userinfobot on Telegram.

    **SSH Command to check existing credential:**
    ```bash
    ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244 \
      "docker exec cd-service-n8n n8n export:credentials --all | grep -i telegram"
    ```

    If credential doesn't exist, create via n8n UI at https://n8n.yourdomain.com/credentials
  </action>
  <verify>
    # Check credential exists (via SSH)
    ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244 \
      "docker exec cd-service-n8n n8n export:credentials --all 2>/dev/null | grep -c telegramApi"
    # Should return 1 or more

    # Check variable exists
    # Variables can be checked via n8n API: GET /api/v1/variables
  </verify>
  <done>n8n has Telegram API credential and TELEGRAM_CHAT_ID variable configured</done>
</task>

<task type="auto">
  <name>Task 3: Deploy and activate error handler</name>
  <files>None (n8n deployment)</files>
  <action>
    1. Import the updated workflow_error_handler.json into n8n:
       - Via UI: Workflows > Import from File
       - Via API: POST /api/v1/workflows with the JSON

    2. Activate the workflow (must be active to receive error triggers)

    3. Set as default error workflow in n8n settings:
       - n8n Settings > Workflow Settings > Default Error Workflow
       - Select "System: Error Handler"

    4. Test the error handler:
       - Create a test workflow with a Code node that throws: `throw new Error('Test error for SC-1.2')`
       - Execute it
       - Verify Telegram notification received within 60 seconds

    **SSH commands for deployment:**
    ```bash
    # Copy updated workflow to server
    scp -i ~/cyber-squire-ops/cyber-squire-ops.pem \
      COREDIRECTIVE_ENGINE/workflow_error_handler.json \
      ec2-user@54.234.155.244:/tmp/

    # Import via n8n CLI
    ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244 \
      "docker exec cd-service-n8n n8n import:workflow --input=/tmp/workflow_error_handler.json"
    ```

    Note: Setting as default error workflow requires UI access or API call.
  </action>
  <verify>
    # Verify workflow imported and active
    ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244 \
      "docker exec cd-service-n8n n8n export:workflow --all | grep -A2 'Error Handler'"
    # Should show workflow exists

    # Manual test: Trigger error in n8n, verify Telegram alert received
  </verify>
  <done>Error handler workflow deployed, activated, and set as default error workflow in n8n</done>
</task>

</tasks>

<verification>
1. JSON validation: `grep -E "api.telegram.org|YOUR_CHAT_ID" COREDIRECTIVE_ENGINE/workflow_error_handler.json` returns empty
2. Credential check: n8n has telegramApi credential configured
3. Variable check: n8n has TELEGRAM_CHAT_ID variable
4. Functional test (SC-1.2): Intentionally trigger error, receive Telegram alert within 60 seconds
</verification>

<success_criteria>
- workflow_error_handler.json uses n8n credentials (no hardcoded tokens)
- Error handler deployed and activated in n8n
- Error handler set as default error workflow
- Test error sends Telegram notification within 60 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-02-SUMMARY.md`
</output>
