---
phase: 01-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - COREDIRECTIVE_ENGINE/docker-compose.yaml
autonomous: true

must_haves:
  truths:
    - "Ollama responds within 5 seconds after 30+ minutes of inactivity"
    - "Ollama model stays loaded in memory between requests"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/docker-compose.yaml"
      provides: "OLLAMA_KEEP_ALIVE environment variable"
      contains: "OLLAMA_KEEP_ALIVE=24h"
  key_links:
    - from: "docker-compose.yaml"
      to: "cd-service-ollama container"
      via: "environment variable"
      pattern: "OLLAMA_KEEP_ALIVE"
---

<objective>
Configure Ollama Docker container to keep models loaded for 24 hours, preventing cold start delays.

Purpose: ADHD workflows require instant response. A 30-second cold start during "activation paralysis" moments will cause the user to abandon the task. This is the highest-priority infrastructure fix.

Output: Updated docker-compose.yaml with OLLAMA_KEEP_ALIVE=24h environment variable.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md (Section 1: Ollama Timeout & Memory Issues)
@COREDIRECTIVE_ENGINE/docker-compose.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OLLAMA_KEEP_ALIVE to docker-compose.yaml</name>
  <files>COREDIRECTIVE_ENGINE/docker-compose.yaml</files>
  <action>
    Add `OLLAMA_KEEP_ALIVE=24h` to the cd-service-ollama environment section.

    Current state (lines 53-64):
    ```yaml
    cd-service-ollama:
      image: ollama/ollama:latest
      container_name: cd-service-ollama
      restart: always
      ports:
        - "11434:11434"
      volumes:
        - ./CD_VOL_OLLAMA:/root/.ollama:z
      environment:
        - OLLAMA_HOST=0.0.0.0:11434
    ```

    Add this line after OLLAMA_HOST:
    ```yaml
        - OLLAMA_KEEP_ALIVE=24h
    ```

    Note: 24h is preferred over -1 (infinite) to allow occasional memory cleanup during low-usage periods.
  </action>
  <verify>
    grep "OLLAMA_KEEP_ALIVE=24h" COREDIRECTIVE_ENGINE/docker-compose.yaml
    # Should return the line with OLLAMA_KEEP_ALIVE=24h
  </verify>
  <done>docker-compose.yaml contains OLLAMA_KEEP_ALIVE=24h in cd-service-ollama environment section</done>
</task>

<task type="auto">
  <name>Task 2: Deploy updated Ollama container</name>
  <files>None (remote execution)</files>
  <action>
    SSH to EC2 and apply the docker-compose changes:

    1. SSH to EC2: `ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244`
    2. Navigate to stack: `cd /opt/COREDIRECTIVE_ENGINE` (or wherever deployed)
    3. Pull changes or copy file
    4. Restart Ollama: `docker compose up -d cd-service-ollama`
    5. Verify environment: `docker exec cd-service-ollama env | grep OLLAMA_KEEP_ALIVE`

    Expected output: `OLLAMA_KEEP_ALIVE=24h`

    Note: This will restart Ollama but not affect n8n or PostgreSQL.
  </action>
  <verify>
    ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244 \
      "docker exec cd-service-ollama env | grep OLLAMA_KEEP_ALIVE"
    # Should output: OLLAMA_KEEP_ALIVE=24h
  </verify>
  <done>OLLAMA_KEEP_ALIVE=24h visible in running container environment</done>
</task>

</tasks>

<verification>
1. Configuration check: `grep "OLLAMA_KEEP_ALIVE" COREDIRECTIVE_ENGINE/docker-compose.yaml` returns line
2. Runtime check: `docker exec cd-service-ollama env | grep OLLAMA_KEEP_ALIVE` returns `OLLAMA_KEEP_ALIVE=24h`
3. Functional check (manual - for SC-1.1 validation later):
   - Send a request to Ollama
   - Wait 30 minutes
   - Send another request
   - Response time should be <5 seconds (not 30+ second cold start)
</verification>

<success_criteria>
- OLLAMA_KEEP_ALIVE=24h in docker-compose.yaml
- Environment variable visible in running container
- Ollama container restarts successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md`
</output>
