---
phase: 01-infrastructure-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - COREDIRECTIVE_ENGINE/workflow_master_router_v5.json
  - COREDIRECTIVE_ENGINE/workflow_financial_warroom.json
  - COREDIRECTIVE_ENGINE/workflow_master_router_with_logging.json
  - COREDIRECTIVE_ENGINE/workflow_master_router_original.json
  - COREDIRECTIVE_ENGINE/workflow_master_router_stable.json
  - COREDIRECTIVE_ENGINE/workflow_master_router_v4.json
  - COREDIRECTIVE_ENGINE/workflow_adhd_commander_v2.json
  - COREDIRECTIVE_ENGINE/deploy_12wy.sh
autonomous: true

must_haves:
  truths:
    - "Zero workflow files contain hardcoded Telegram bot tokens"
    - "All workflows use n8n credential references for authentication"
    - "grep validation passes for sensitive patterns"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/*.json"
      provides: "Sanitized workflow files"
      contains: "credentials"
  key_links:
    - from: "HTTP Request nodes (Telegram)"
      to: "n8n Telegram credential"
      via: "credential reference instead of hardcoded URL"
      pattern: "telegramApi"
---

<objective>
Audit all workflow files for hardcoded credentials and migrate to n8n credential system.

Purpose: Hardcoded credentials in workflow JSON files are a security risk (see PITFALLS.md section 5). As a security professional, this is unacceptable. All Telegram bot tokens must be migrated to n8n credentials.

Output: All 8 identified files sanitized, grep validation passes (SC-1.3).
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md (Section 5: Credential Exposure in Workflow Exports)
@.planning/phases/01-infrastructure-foundation/01-02-SUMMARY.md (for credential setup reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and document hardcoded credentials</name>
  <files>None (analysis only)</files>
  <action>
    Run grep to identify all files with hardcoded Telegram tokens:

    ```bash
    grep -rE "[0-9]{10}:[A-Za-z0-9_-]{35}" COREDIRECTIVE_ENGINE/ --include="*.json" --include="*.sh"
    ```

    Known affected files (from planning context grep):
    1. workflow_financial_warroom.json
    2. workflow_master_router_v5.json
    3. workflow_error_handler.json (handled in 01-02)
    4. workflow_master_router_with_logging.json
    5. workflow_master_router_original.json
    6. workflow_master_router_stable.json
    7. workflow_master_router_v4.json
    8. workflow_adhd_commander_v2.json
    9. deploy_12wy.sh

    For each file, document:
    - Line number of hardcoded credential
    - Node name containing the credential
    - Whether it's an active workflow or backup
  </action>
  <verify>
    # Count files with hardcoded tokens
    grep -rE "[0-9]{10}:[A-Za-z0-9_-]{35}" COREDIRECTIVE_ENGINE/ --include="*.json" --include="*.sh" -l | wc -l
    # Current: 9 files
  </verify>
  <done>Audit complete, all files with hardcoded credentials documented</done>
</task>

<task type="auto">
  <name>Task 2: Migrate active workflows to credential references</name>
  <files>
    COREDIRECTIVE_ENGINE/workflow_master_router_v5.json
    COREDIRECTIVE_ENGINE/workflow_financial_warroom.json
    COREDIRECTIVE_ENGINE/workflow_adhd_commander_v2.json
  </files>
  <action>
    For each ACTIVE workflow (v5, financial_warroom, adhd_commander_v2), replace hardcoded HTTP Request nodes with n8n Telegram nodes using credentials.

    **Pattern to find (in each file):**
    ```json
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot<TOKEN_IN_N8N_CREDENTIALS>/sendMessage",
        ...
      },
      "type": "n8n-nodes-base.httpRequest",
      ...
    }
    ```

    **Replace with:**
    ```json
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "={{ $json.parse_mode || 'Markdown' }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-creds",
          "name": "Telegram Bot"
        }
      },
      ...
    }
    ```

    **workflow_master_router_v5.json:**
    - Line 172: "Send" node - replace httpRequest with telegram node
    - Preserve node ID and position for connection integrity

    **workflow_financial_warroom.json:**
    - Find Telegram send nodes, apply same pattern

    **workflow_adhd_commander_v2.json:**
    - Find Telegram send nodes, apply same pattern

    After each file edit, verify JSON is valid: `python -m json.tool < file.json > /dev/null`
  </action>
  <verify>
    # Verify no hardcoded tokens in active workflows
    grep -E "[0-9]{10}:[A-Za-z0-9_-]{35}" \
      COREDIRECTIVE_ENGINE/workflow_master_router_v5.json \
      COREDIRECTIVE_ENGINE/workflow_financial_warroom.json \
      COREDIRECTIVE_ENGINE/workflow_adhd_commander_v2.json
    # Should return NO matches (empty output)

    # Verify JSON validity
    python3 -m json.tool < COREDIRECTIVE_ENGINE/workflow_master_router_v5.json > /dev/null && echo "v5 valid"
    python3 -m json.tool < COREDIRECTIVE_ENGINE/workflow_financial_warroom.json > /dev/null && echo "warroom valid"
    python3 -m json.tool < COREDIRECTIVE_ENGINE/workflow_adhd_commander_v2.json > /dev/null && echo "adhd valid"
  </verify>
  <done>Active workflows (v5, warroom, adhd_commander_v2) use credential references</done>
</task>

<task type="auto">
  <name>Task 3: Sanitize backup/legacy workflows and deploy script</name>
  <files>
    COREDIRECTIVE_ENGINE/workflow_master_router_with_logging.json
    COREDIRECTIVE_ENGINE/workflow_master_router_original.json
    COREDIRECTIVE_ENGINE/workflow_master_router_stable.json
    COREDIRECTIVE_ENGINE/workflow_master_router_v4.json
    COREDIRECTIVE_ENGINE/deploy_12wy.sh
  </files>
  <action>
    For BACKUP/LEGACY workflows, apply the same credential migration pattern.

    These files appear to be older versions kept for reference. Options:
    1. **Migrate**: Same credential pattern as active workflows
    2. **Delete**: If truly obsolete, remove the files
    3. **Archive**: Move to `COREDIRECTIVE_ENGINE/archive/` directory

    Recommended: Migrate all to credential references for consistency. If they're imported later, they should work without exposing secrets.

    **deploy_12wy.sh:**
    - Check for hardcoded tokens in shell script
    - Replace with environment variable reference: `$TELEGRAM_BOT_TOKEN`
    - Or remove if the script is deprecated

    Apply same grep verification after each file.
  </action>
  <verify>
    # Full validation - zero hardcoded credentials in entire directory
    grep -rE "[0-9]{10}:[A-Za-z0-9_-]{35}" COREDIRECTIVE_ENGINE/ --include="*.json" --include="*.sh" | wc -l
    # Should return 0

    # SC-1.3 validation command from STATE.md:
    grep -rE "(sk-ant|ghp_|[0-9]{10}:[A-Za-z0-9_-]{35})" COREDIRECTIVE_ENGINE/ | wc -l
    # Should return 0
  </verify>
  <done>All workflow files and scripts sanitized, SC-1.3 grep validation passes</done>
</task>

</tasks>

<verification>
1. Pre-check: Count files with hardcoded tokens (should be 9 initially)
2. Post-check: Same grep returns 0 files
3. JSON validity: All modified .json files pass `python -m json.tool` validation
4. SC-1.3: `grep -rE "(sk-ant|ghp_|[0-9]{10}:[A-Za-z0-9_-]{35})" COREDIRECTIVE_ENGINE/ | wc -l` returns 0
5. Functional: Active workflows still work (import to n8n and test)
</verification>

<success_criteria>
- All 9 files audited and modified
- Zero hardcoded Telegram tokens in any workflow JSON
- Zero hardcoded credentials in shell scripts
- All JSON files remain valid
- SC-1.3 grep validation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-04-SUMMARY.md`
</output>
