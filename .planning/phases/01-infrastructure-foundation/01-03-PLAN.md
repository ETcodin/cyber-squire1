---
phase: 01-infrastructure-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json (new)
autonomous: true

must_haves:
  truths:
    - "Webhook registration validated daily at fixed time"
    - "Alert sent if webhook URL doesn't match expected domain"
    - "Webhook automatically re-registered if misconfigured"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json"
      provides: "Daily webhook health check workflow"
      contains: "getWebhookInfo"
  key_links:
    - from: "Schedule Trigger"
      to: "Telegram API getWebhookInfo"
      via: "HTTP Request node"
      pattern: "getWebhookInfo"
    - from: "Check Result node"
      to: "setWebhook API"
      via: "conditional re-registration"
---

<objective>
Create a scheduled workflow that checks Telegram webhook status daily and re-registers if misconfigured.

Purpose: Webhooks can silently fail (see PITFALLS.md section 2). Without daily validation, the bot could be "dead" for days without anyone knowing. This is unacceptable for ADHD-critical infrastructure.

Output: New workflow_webhook_healthcheck.json deployed with daily cron schedule visible in n8n.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md (Section 2: Telegram Webhook Reliability)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook health check workflow JSON</name>
  <files>COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json</files>
  <action>
    Create a new workflow with these nodes:

    **1. Schedule Trigger**
    - Cron expression: `0 8 * * *` (8:00 AM daily)
    - Timezone: Match user's timezone (EST/EDT)

    **2. Get Bot Token (from credential)**
    - Use n8n Code node to construct API URL
    - Token from n8n credential or variable

    **3. Check Webhook Info**
    - HTTP Request: GET `https://api.telegram.org/bot{TOKEN}/getWebhookInfo`
    - Parse response JSON

    **4. Validate Webhook URL**
    - Code node: Check if `result.url` contains expected domain
    - Expected domain: from n8n variable `WEBHOOK_DOMAIN` or hardcoded if static

    **5. Branch: Is Valid?**
    - If valid: Log success, exit
    - If invalid: Continue to re-registration

    **6. Re-register Webhook (if invalid)**
    - HTTP Request: POST `https://api.telegram.org/bot{TOKEN}/setWebhook`
    - Body: `{ "url": "https://{EXPECTED_DOMAIN}/webhook/telegram-bot" }`

    **7. Send Alert (if re-registered)**
    - Telegram message: "Webhook was misconfigured, re-registered to {URL}"

    Create the JSON file with this structure. Use n8n credentials for the Telegram bot token.

    **Key fields to include:**
    ```json
    {
      "name": "System: Webhook Health Check",
      "nodes": [
        {
          "parameters": {
            "rule": {
              "interval": [{ "field": "cronExpression", "expression": "0 8 * * *" }]
            }
          },
          "name": "Daily 8AM",
          "type": "n8n-nodes-base.scheduleTrigger",
          ...
        },
        // ... rest of nodes
      ],
      "settings": {
        "executionOrder": "v1"
      },
      "tags": [{ "name": "System" }]
    }
    ```
  </action>
  <verify>
    # File exists and has required components
    test -f COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json && echo "File exists"
    grep "getWebhookInfo" COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json
    grep "scheduleTrigger" COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json
    grep "setWebhook" COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json
  </verify>
  <done>workflow_webhook_healthcheck.json created with schedule trigger, webhook check, and re-registration logic</done>
</task>

<task type="auto">
  <name>Task 2: Deploy and activate health check workflow</name>
  <files>None (n8n deployment)</files>
  <action>
    1. Copy workflow to server:
       ```bash
       scp -i ~/cyber-squire-ops/cyber-squire-ops.pem \
         COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json \
         ec2-user@54.234.155.244:/tmp/
       ```

    2. Import into n8n:
       ```bash
       ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244 \
         "docker exec cd-service-n8n n8n import:workflow --input=/tmp/workflow_webhook_healthcheck.json"
       ```

    3. Activate the workflow (scheduled triggers only fire when active)

    4. Verify schedule appears in n8n:
       - Open n8n UI
       - Navigate to workflow
       - Confirm "Active" toggle is ON
       - Confirm schedule trigger shows "Daily at 8:00 AM"

    5. Manual test: Execute workflow manually to verify it works:
       - Should call getWebhookInfo
       - Should show webhook URL in execution output
       - Should NOT re-register (if webhook is currently valid)
  </action>
  <verify>
    # Verify workflow exists and is active
    ssh -i ~/cyber-squire-ops/cyber-squire-ops.pem ec2-user@54.234.155.244 \
      "docker exec cd-service-n8n n8n export:workflow --all 2>/dev/null | grep -A5 'Webhook Health'"

    # SC-1.4 validation: Cron job visible in n8n UI (manual verification)
  </verify>
  <done>Webhook health check workflow deployed, activated, and cron schedule visible in n8n (SC-1.4)</done>
</task>

</tasks>

<verification>
1. File check: `test -f COREDIRECTIVE_ENGINE/workflow_webhook_healthcheck.json`
2. Content check: JSON contains scheduleTrigger, getWebhookInfo, setWebhook components
3. Deployment check: Workflow visible in n8n workflow list
4. Activation check: Workflow is active (toggle ON)
5. SC-1.4: Webhook health check scheduled cron job visible in n8n
</verification>

<success_criteria>
- workflow_webhook_healthcheck.json created with all required nodes
- Workflow deployed to n8n
- Workflow activated
- Cron schedule (daily 8AM) visible in n8n UI
- Manual execution succeeds (validates current webhook status)
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-03-SUMMARY.md`
</output>
