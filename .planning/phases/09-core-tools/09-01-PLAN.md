---
phase: 09-core-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_created:
  - COREDIRECTIVE_ENGINE/workflows/tool_system_status.json

must_haves:
  truths:
    - "System status check returns health of all services"
    - "Response time <5 seconds"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/tool_system_status.json"
      provides: "System health check workflow"
      contains: "EC2, Docker, n8n, Ollama health checks"
---

<objective>
Create System Status tool to check health of all infrastructure components.

Purpose: Provide instant visibility into system health via Telegram. Critical for ADHD workflows where SSH and manual checks create too much friction.

Output: "System status" command returns health of EC2, Docker containers, n8n, and Ollama.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure-foundation/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create system status workflow structure</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_system_status.json</files>
  <action>
    Create n8n workflow with:

    Trigger: Execute Workflow (called from supervisor)

    Health checks to perform:
    1. EC2 metrics (CPU, memory, disk)
    2. Docker container status (all containers)
    3. n8n health (database connection)
    4. Ollama health (API response time)

    Output format:
    ```
    **System Status**

    ✅ EC2: Healthy (CPU: 12%, Memory: 45%, Disk: 22%)
    ✅ Docker: 5/5 containers running
    ✅ n8n: Healthy (23 active workflows)
    ✅ Ollama: Healthy (2.3s response time)

    **Next step:** All systems operational
    ```

    This satisfies TOOL-01 requirement.
  </action>
  <verify>
    # Create workflow in n8n
    # Structure includes all 4 health checks
  </verify>
  <done>System status workflow structure created</done>
</task>

<task type="auto">
  <name>Task 2: Implement EC2 metrics check</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_system_status.json</files>
  <action>
    Add SSH Execute Command node to get EC2 metrics:

    Commands:
    ```bash
    # CPU usage (average over 1 minute)
    top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1

    # Memory usage
    free | grep Mem | awk '{print int($3/$2 * 100)}'

    # Disk usage
    df -h / | tail -1 | awk '{print $5}' | cut -d'%' -f1
    ```

    Or use single compound command:
    ```bash
    echo "CPU:$(top -bn1 | grep 'Cpu(s)' | awk '{print $2}' | cut -d'%' -f1)%,MEM:$(free | grep Mem | awk '{print int($3/$2 * 100)}')%,DISK:$(df -h / | tail -1 | awk '{print $5}')"
    ```

    Parse output and categorize:
    - Green (✅): CPU <50%, Memory <70%, Disk <80%
    - Yellow (⚠️): CPU 50-80%, Memory 70-85%, Disk 80-90%
    - Red (❌): CPU >80%, Memory >85%, Disk >90%

    SSH config:
    - Host: 54.234.155.244
    - User: ec2-user
    - Key: from n8n credentials
  </action>
  <verify>
    # Run workflow
    # Verify EC2 metrics returned
    # Check values are realistic (0-100%)
  </verify>
  <done>EC2 metrics check implemented</done>
</task>

<task type="auto">
  <name>Task 3: Implement Docker container health check</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_system_status.json</files>
  <action>
    Add SSH Execute Command node to check Docker:

    Command:
    ```bash
    docker ps --format '{{.Names}}:{{.Status}}' | grep -E '(cd-service-|tunnel-|moltbot-)'
    ```

    Expected output:
    ```
    cd-service-db:Up 23 hours (healthy)
    cd-service-n8n:Up 23 hours
    cd-service-ollama:Up 5 minutes
    cd-service-whisper:Up 2 hours (healthy)
    tunnel-cyber-squire:Up 23 hours
    ```

    Parse and categorize:
    - Count total containers
    - Check for "healthy" status where available
    - Flag any "Restarting" or "Exited" containers

    Response format:
    - ✅ All running: "5/5 containers running"
    - ⚠️ Some issues: "4/5 containers running (1 restarting)"
    - ❌ Critical: "3/5 containers running"
  </action>
  <verify>
    # Run workflow
    # Verify container list returned
    # Check count matches actual containers
  </verify>
  <done>Docker container health check implemented</done>
</task>

<task type="auto">
  <name>Task 4: Implement n8n health check</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_system_status.json</files>
  <action>
    Check n8n health via database query:

    PostgreSQL query:
    ```sql
    SELECT COUNT(*) FROM workflow_entity WHERE active = true;
    ```

    This verifies:
    - Database connection works
    - n8n can read workflow data
    - Active workflow count

    Alternative: HTTP health check
    - URL: http://cd-service-n8n:5678/healthz (if endpoint exists)
    - Or check workflow execution count today:
      ```sql
      SELECT COUNT(*) FROM execution_entity
      WHERE started_at > CURRENT_DATE;
      ```

    Response:
    - ✅ "Healthy (23 active workflows)"
    - ⚠️ "Database slow (>5s response)"
    - ❌ "Database unreachable"
  </action>
  <verify>
    # Run workflow
    # Verify n8n health check returns
    # Check workflow count matches reality
  </verify>
  <done>n8n health check implemented</done>
</task>

<task type="auto">
  <name>Task 5: Implement Ollama health check</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_system_status.json</files>
  <action>
    Test Ollama API response time:

    HTTP Request:
    - URL: http://cd-service-ollama:11434/api/generate
    - Method: POST
    - Body:
      ```json
      {
        "model": "qwen2.5:7b",
        "prompt": "Hello",
        "stream": false
      }
      ```
    - Track request duration

    Categorize response time:
    - ✅ <3s: "Healthy (2.3s response)"
    - ⚠️ 3-10s: "Slow (7.8s response)"
    - ❌ >10s or timeout: "Unhealthy (timeout)"

    This also verifies model is loaded (KEEP_ALIVE from Phase 1).

    Note: First request after long idle may be slower (warming up)
  </action>
  <verify>
    # Run workflow
    # Verify Ollama responds
    # Check response time is reasonable
  </verify>
  <done>Ollama health check with response time implemented</done>
</task>

<task type="auto">
  <name>Task 6: Assemble and format status response</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_system_status.json</files>
  <action>
    Combine all health checks into formatted response:

    Template:
    ```
    **System Status**

    {{ec2_status}} EC2: {{ec2_label}} (CPU: {{cpu}}%, Memory: {{memory}}%, Disk: {{disk}}%)
    {{docker_status}} Docker: {{running}}/{{total}} containers running
    {{n8n_status}} n8n: {{n8n_label}} ({{workflow_count}} active workflows)
    {{ollama_status}} Ollama: {{ollama_label}} ({{response_time}}s response)

    **Overall:** {{overall_status}}
    ```

    Overall status logic:
    - All green: "All systems operational ✅"
    - Any yellow: "Minor issues detected ⚠️"
    - Any red: "Critical issues require attention ❌"

    Apply ADHD formatting (from Phase 7):
    - Bold keywords: Healthy, Slow, Critical
    - Clear status indicators: ✅ ⚠️ ❌

    Response time target: <5 seconds (SC-9.1)
  </action>
  <verify>
    # Send "System status" to bot
    # Verify formatted response appears
    # Check response time <5 seconds
  </verify>
  <done>Status response assembled with ADHD formatting</done>
</task>

</tasks>

<verification>
1. Send "System status" via Telegram
2. Verify all 4 components checked (EC2, Docker, n8n, Ollama)
3. Verify response time <5 seconds
4. Check status indicators accurate (✅ ⚠️ ❌)
5. Verify ADHD formatting applied
6. Test with simulated failure (stop a container)
</verification>

<success_criteria>
- System status checks all 4 components (SC-9.1)
- Response time <5 seconds (SC-9.1)
- Health indicators clear and accurate (SC-9.2)
- Output uses ADHD formatting
- Failures detected and flagged appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-tools/09-01-SUMMARY.md`
</output>
