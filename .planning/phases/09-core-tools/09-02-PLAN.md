---
phase: 09-core-tools
plan: 02
type: execute
wave: 2
depends_on: []
files_created:
  - COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json

must_haves:
  truths:
    - "ADHD Commander returns single prioritized task"
    - "Selection explained with reasoning"
  artifacts:
    - path: "COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json"
      provides: "AI-powered task selection from Notion"
      contains: "Notion API integration and selection algorithm"
---

<objective>
Create ADHD Commander tool to select the best task from Notion board.

Purpose: Combat decision paralysis by having AI choose the single most important task based on context (energy level, time of day, deadlines). This is the core ADHD productivity feature.

Output: "What should I work on?" returns ONE task with explanation.
</objective>

<execution_context>
@/Users/et/.claude/get-shit-done/workflows/execute-plan.md
@/Users/et/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
Notion API: https://developers.notion.com/reference/post-database-query
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Notion API integration</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json</files>
  <action>
    Create n8n workflow with Notion integration:

    Configuration:
    - Store Notion API key in n8n credentials
    - Store Notion database ID for task board

    Notion API call to get tasks:
    - Endpoint: POST https://api.notion.com/v1/databases/{database_id}/query
    - Headers:
      - Authorization: Bearer {notion_api_key}
      - Notion-Version: 2022-06-28
    - Filter: Only tasks in "To Do" or "In Progress" status

    Example filter:
    ```json
    {
      "filter": {
        "or": [
          {
            "property": "Status",
            "select": { "equals": "To Do" }
          },
          {
            "property": "Status",
            "select": { "equals": "In Progress" }
          }
        ]
      },
      "sorts": [
        {
          "property": "Priority",
          "direction": "descending"
        }
      ]
    }
    ```

    Note: Assumes Notion database has Status and Priority properties
  </action>
  <verify>
    # Test Notion API call
    # Verify tasks returned
    # Check task properties available
  </verify>
  <done>Notion API integration retrieves task list</done>
</task>

<task type="auto">
  <name>Task 2: Extract task context for AI selection</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json</files>
  <action>
    Parse Notion tasks and extract relevant fields:

    For each task:
    - Title
    - Priority (High/Medium/Low)
    - Status (To Do/In Progress)
    - Deadline (if set)
    - Estimated time (if set)
    - Tags/Labels
    - Last modified date

    Also gather contextual information:
    - Current time of day (morning/afternoon/evening)
    - Day of week
    - User's energy level (could be manual input or inferred)

    Format for AI:
    ```json
    {
      "tasks": [
        {
          "id": "task_123",
          "title": "Implement faster-whisper",
          "priority": "High",
          "status": "In Progress",
          "deadline": "2026-02-06",
          "estimated_time": "3 hours",
          "tags": ["development", "ai"]
        },
        {...}
      ],
      "context": {
        "time_of_day": "morning",
        "day_of_week": "Tuesday",
        "energy_level": "medium"
      }
    }
    ```
  </action>
  <verify>
    # Check task parsing
    # Verify all relevant fields extracted
  </verify>
  <done>Task context extracted and formatted for AI</done>
</task>

<task type="auto">
  <name>Task 3: Implement AI selection algorithm</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json</files>
  <action>
    Use Ollama to select the best task via AI Agent node:

    Prompt:
    ```
    You are an ADHD productivity coach. Select ONE task from this list that the user should work on RIGHT NOW.

    Tasks:
    {{tasks_json}}

    Context:
    - Time: {{time_of_day}}
    - Day: {{day_of_week}}
    - Energy level: {{energy_level}}

    Selection criteria:
    1. Deadline urgency (due soon = higher priority)
    2. Task already in progress (reduce context switching)
    3. Time available vs estimated time (will it fit?)
    4. Energy level vs task complexity
    5. Priority level

    Respond with JSON:
    {
      "task_id": "selected task ID",
      "reason": "Brief explanation why this task (1 sentence)"
    }
    ```

    Parse AI response to extract:
    - Selected task ID
    - Reasoning

    Fallback if AI fails:
    - Use rule-based selection:
      1. In Progress tasks first (reduce context switch)
      2. Then High priority + nearest deadline
      3. Then High priority
      4. Then any task
  </action>
  <verify>
    # Test with sample task list
    # Verify AI selects appropriate task
    # Check reasoning is sensible
  </verify>
  <done>AI selection algorithm chooses single task</done>
</task>

<task type="auto">
  <name>Task 4: Format ADHD Commander response</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json</files>
  <action>
    Format response with selected task and explanation:

    Template:
    ```
    **ADHD Commander**

    **Work on:** {{task_title}}

    **Why:** {{reasoning}}

    **Details:**
    â€¢ Priority: {{priority}}
    â€¢ Deadline: {{deadline}}
    â€¢ Estimated time: {{estimated_time}}

    **Next step:** Open Notion and start this task
    ```

    Add Notion URL button:
    ```
    [ View in Notion ðŸ”— ]
    ```

    Button links directly to task page.

    Apply ADHD formatting:
    - Bold task title
    - Bold "Why" reasoning
    - Max 3 detail bullets
    - Clear next step

    This satisfies TOOL-02 requirement (SC-9.3, SC-9.4).
  </action>
  <verify>
    # Send "What should I work on?"
    # Verify single task returned
    # Check explanation provided
    # Verify Notion link button works
  </verify>
  <done>ADHD Commander response formatted and actionable</done>
</task>

<task type="auto">
  <name>Task 5: Add optional energy level input</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json</files>
  <action>
    Allow user to specify energy level:

    Input variations:
    - "What should I work on?" â†’ infer medium energy
    - "What should I work on? High energy" â†’ use high
    - "What should I work on? Low energy" â†’ use low

    Parse energy level from message:
    ```javascript
    const message = $json.message.text.toLowerCase();
    let energy = 'medium'; // default

    if (message.includes('high energy') || message.includes('energized')) {
      energy = 'high';
    } else if (message.includes('low energy') || message.includes('tired')) {
      energy = 'low';
    }

    return { energy };
    ```

    Selection adjustments by energy:
    - High energy: Complex tasks, long estimated time OK
    - Medium energy: Moderate tasks, 1-3 hour tasks
    - Low energy: Simple tasks, quick wins, already-started tasks

    This personalization improves task-fit accuracy.
  </action>
  <verify>
    # Test "What should I work on? Low energy"
    # Verify energy level passed to AI
    # Check task selection matches energy level
  </verify>
  <done>Energy level input personalizes task selection</done>
</task>

<task type="auto">
  <name>Task 6: Add caching to prevent rate limiting</name>
  <files>COREDIRECTIVE_ENGINE/workflows/tool_adhd_commander.json</files>
  <action>
    Cache Notion task list to reduce API calls:

    Caching strategy:
    1. Store task list in PostgreSQL
    2. TTL: 5 minutes (tasks don't change that often)
    3. On request:
       - Check cache timestamp
       - If <5 min old: Use cached data
       - If >5 min old: Fetch from Notion, update cache

    PostgreSQL schema:
    ```sql
    CREATE TABLE notion_task_cache (
      id SERIAL PRIMARY KEY,
      tasks JSONB NOT NULL,
      fetched_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    ```

    Logic:
    ```sql
    SELECT tasks FROM notion_task_cache
    WHERE fetched_at > NOW() - INTERVAL '5 minutes'
    ORDER BY fetched_at DESC
    LIMIT 1;
    ```

    If no cache: Fetch from Notion, insert new row.

    This prevents hitting Notion rate limits (3 requests/second).
  </action>
  <verify>
    # Send command twice within 5 minutes
    # Verify second request uses cache (faster)
    # Check database has cached tasks
  </verify>
  <done>Task list caching prevents rate limiting</done>
</task>

</tasks>

<verification>
1. Send "What should I work on?" via Telegram
2. Verify single task returned (not a list)
3. Verify explanation provided (SC-9.4)
4. Verify Notion link button works
5. Test with different energy levels
6. Test cache by sending command twice
</verification>

<success_criteria>
- Returns single prioritized task (SC-9.3)
- Explains why task was selected (SC-9.4)
- Notion link button opens correct task
- Energy level affects selection
- Caching prevents rate limiting
- Response uses ADHD formatting
</success_criteria>

<output>
After completion, create `.planning/phases/09-core-tools/09-02-SUMMARY.md`
</output>
